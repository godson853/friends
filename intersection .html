<!DOCTYPE html>
 <head>
	 <title>friendszonechat </title>
	 <?php session_start(); // If user is logged in, header them away
if(isset($_SESSION["username"])){ 	header("location: message.php?msg=NO to that weenis"); exit(); } ?><?php // Ajax calls this NAME CHECK code to execute
if(isset($_POST["usernamecheck"])){ 	include_once("php_includes/db_conx.php"); 	$username = preg_replace('#[^a-z0-9]#i', '', $_POST['usernamecheck']); 	$sql = "SELECT id FROM users WHERE username='$username' LIMIT 1"; $query = mysqli_query($db_conx, $sql); $uname_check = mysqli_num_rows($query); if (strlen($username) < 3 || strlen($username) > 16) { 	 echo '<strong style="color:#F00;">3 - 16 characters please</strong>'; 	 exit(); } 	if (is_numeric($username[0])) { 	 echo '<strong style="color:#F00;">Usernames must begin with a letter</strong>'; 	 exit(); } if ($uname_check < 1) { 	 echo '<strong style="color:#009900;">' . $username . ' is OK</strong>'; 	 exit(); } else { 	 echo '<strong style="color:#F00;">' . $username . ' is taken</strong>'; 	 exit(); } } ?><?php // Ajax calls this REGISTRATION code to execute
if(isset($_POST["u"])){ 	// CONNECT TO THE DATABASE
	include_once("php_includes/db_conx.php"); 	// GATHER THE POSTED DATA INTO LOCAL VARIABLES
	$u = preg_replace('#[^a-z0-9]#i', '', $_POST['u']); 	$e = mysqli_real_escape_string($db_conx, $_POST['e']); 	$p = $_POST['p']; 	$g = preg_replace('#[^a-z]#', '', $_POST['g']); 	$c = preg_replace('#[^a-z ]#i', '', $_POST['c']); 	// GET USER IP ADDRESS
$ip = preg_replace('#[^0-9.]#', '', getenv('REMOTE_ADDR')); 	// DUPLICATE DATA CHECKS FOR USERNAME AND EMAIL
	$sql = "SELECT id FROM users WHERE username='$u' LIMIT 1"; $query = mysqli_query($db_conx, $sql); 	$u_check = mysqli_num_rows($query); 	// -------------------------------------------
	$sql = "SELECT id FROM users WHERE email='$e' LIMIT 1"; $query = mysqli_query($db_conx, $sql); 	$e_check = mysqli_num_rows($query); 	// FORM DATA ERROR HANDLING
	if($u == "" || $e == "" || $p == "" || $g == "" || $c == ""){ 		echo "The form submission is missing values."; exit(); 	} else if ($u_check > 0){ echo "The username you entered is alreay taken"; exit(); 	} else if ($e_check > 0){ echo "That email address is already in use in the system"; exit(); 	} else if (strlen($u) < 3 || strlen($u) > 16) { echo "Username must be between 3 and 16 characters"; exit(); } else if (is_numeric($u[0])) { echo 'Username cannot begin with a number'; exit(); } else { 	// END FORM DATA ERROR HANDLING
	 // Begin Insertion of data into the database
		// Hash the password and apply your own mysterious unique salt
		$cryptpass = crypt($p); 		include_once ("php_includes/randStrGen.php"); 		$p_hash = randStrGen(20)."$cryptpass".randStrGen(20); 		// Add user info into the database table for the main site table
		$sql = "INSERT INTO users (username, email, password, gender, country, ip, signup, lastlogin, notescheck) 		 VALUES('$u','$e','$p_hash','$g','$c','$ip',now(),now(),now())"; 		$query = mysqli_query($db_conx, $sql); 		$uid = mysqli_insert_id($db_conx); 		// Establish their row in the useroptions table
		$sql = "INSERT INTO useroptions (id, username, background) VALUES ('$uid','$u','original')"; 		$query = mysqli_query($db_conx, $sql); 		// Create directory(folder) to hold each user's files(pics, MP3s, etc.)
		if (!file_exists("user/$u")) { 			mkdir("user/$u", 0755); 		} 		// Email the user their activation link
		$to = "$e";							 		$from = "auto_responder@friendszonechat.atwebpages.com"; 		$subject = 'friendszonechat Account Activation'; 		$message = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>friendszonchat Message</title></head><body style="margin:0px; font-family:Tahoma, Geneva, sans-serif;"><div style="padding:10px; background:#333; font-size:24px; color:#CCC;"><a href="http://www.friendzmeet.com"><img src="http://www.friendszonechat.atwebpages.com/images/logo.png" width="36" height="30" alt="friendszonechat" style="border:none; float:left;"></a>friendzmeet Account Activation</div><div style="padding:24px; font-size:17px;">Hello '.$u.',<br /><br />Click the link below to activate your account when ready:<br /><br /><a href="http://www.friendszonechat.atwebpages.com/activation.php?id='.$uid.'&u='.$u.'&e='.$e.'&p='.$p_hash.'">Click here to activate your account now</a><br /><br />Login after successful activation using your:<br />* E-mail Address: <b>'.$e.'</b></div></body></html>'; 		$headers = "From: $from\n"; $headers .= "MIME-Version: 1.0\n"; $headers .= "Content-type: text/html; charset=iso-8859-1\n"; 		mail($to, $subject, $message, $headers); 		echo "signup_success"; 		exit(); 	} 	exit(); } ?> <!DOCTYPE html> <html> <head> <meta charset="UTF-8"> <title>Sign Up</title> <link rel="icon" href="favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="style/style.css"> <style type="text/css"> #signupform{ 	margin-top:24px;	 } #signupform > div { 	margin-top: 12px;	 } #signupform > input,select { 	width: 200px; 	padding: 3px; 	background: #F3F9DD; } #signupbtn { 	font-size:18px; 	padding: 12px; } #terms { 	border:#CCC 1px solid; 	background: #F5F5F5; 	padding: 12px; } </style> <script src="js/main.js"></script> <script src="js/ajax.js"></script> <script> function restrict(elem){ 	var tf = _(elem); 	var rx = new RegExp; 	if(elem == "email"){ 		rx = /[' "]/gi; 	} else if(elem == "username"){ 		rx = /[^a-z0-9]/gi; 	} 	tf.value = tf.value.replace(rx, ""); } function emptyElement(x){ 	_(x).innerHTML = ""; } function checkusername(){ 	var u = _("username").value; 	if(u != ""){ 		_("unamestatus").innerHTML = 'checking ...'; 		var ajax = ajaxObj("POST", "signup.php"); ajax.onreadystatechange = function() { 	 if(ajaxReturn(ajax) == true) { 	 _("unamestatus").innerHTML = ajax.responseText; 	 } } ajax.send("usernamecheck="+u); 	} } function signup(){ 	var u = _("username").value; 	var e = _("email").value; 	var p1 = _("pass1").value; 	var p2 = _("pass2").value; 	var c = _("country").value; 	var g = _("gender").value; 	var status = _("status"); 	if(u == "" || e == "" || p1 == "" || p2 == "" || c == "" || g == ""){ 		status.innerHTML = "Fill out all of the form data"; 	} else if(p1 != p2){ 		status.innerHTML = "Your password fields do not match"; 	} else if( _("terms").style.display == "none"){ 		status.innerHTML = "Please view the terms of use"; 	} else { 		_("signupbtn").style.display = "none"; 		status.innerHTML = 'please wait ...'; 		var ajax = ajaxObj("POST", "signup.php"); ajax.onreadystatechange = function() { 	 if(ajaxReturn(ajax) == true) { 	 if(ajax.responseText != "signup_success"){ 					status.innerHTML = ajax.responseText; 					_("signupbtn").style.display = "block"; 				} else { 					window.scrollTo(0,0); 					_("signupform").innerHTML = "OK "+u+", check your email inbox and junk mail box at <u>"+e+"</u> in a moment to complete the sign up process by activating your account. You will not be able to do anything on the site until you successfully activate your account."; 				} 	 } } ajax.send("u="+u+"&e="+e+"&p="+p1+"&c="+c+"&g="+g); 	} } function openTerms(){ 	_("terms").style.display = "block"; 	emptyElement("status"); } /* function addEvents(){ 	_("elemID").addEventListener("click", func, false); } window.onload = addEvents; */ </script> </head> <body> <?php include_once("template_pageTop.php"); ?> <div id="pageMiddle"> <h3>Sign Up Here</h3> <form name="signupform" id="signupform" onsubmit="return false;"> <div>Username: </div> <input id="username" type="text" onblur="checkusername()" onkeyup="restrict('username')" maxlength="16"> <span id="unamestatus"></span> <div>Email Address:</div> <input id="email" type="text" onfocus="emptyElement('status')" onkeyup="restrict('email')" maxlength="88"> <div>Create Password:</div> <input id="pass1" type="password" onfocus="emptyElement('status')" maxlength="16"> <div>Confirm Password:</div> <input id="pass2" type="password" onfocus="emptyElement('status')" maxlength="16"> <div>Gender:</div> <select id="gender" onfocus="emptyElement('status')"> <option value=""></option> <option value="m">Male</option> <option value="f">Female</option> </select> <div>Country:</div> <select id="country" onfocus="emptyElement('status')"> <?php include_once("template_country_list.php"); ?> </select> <div> <a href="#" onclick="return false" onmousedown="openTerms()"> View the Terms Of Use </a> </div> <div id="terms" style="display:none;"> <h3>Web Intersect Terms Of Use</h3> <p>1. Play nice here.</p> <p>2. Take a bath before you visit.</p> <p>3. Brush your teeth before bed.</p> </div> <br /><br /> <button id="signupbtn" onclick="signup()">Create Account</button> <span id="status"></span> </form> </div> <?php include_once("template_pageBottom.php"); ?> </body> </html>
	 <?php if (isset($_GET['id']) && isset($_GET['u']) && isset($_GET['e']) && isset($_GET['p'])) { 	// Connect to database and sanitize incoming $_GET variables
include_once("php_includes/db_conx.php"); $id = preg_replace('#[^0-9]#i', '', $_GET['id']); 	$u = preg_replace('#[^a-z0-9]#i', '', $_GET['u']); 	$e = mysqli_real_escape_string($db_conx, $_GET['e']); 	$p = mysqli_real_escape_string($db_conx, $_GET['p']); 	// Evaluate the lengths of the incoming $_GET variable
	if($id == "" || strlen($u) < 3 || strlen($e) < 5 || strlen($p) != 74){ 		// Log this issue into a text file and email details to yourself
		header("location: message.php?msg=activation_string_length_issues"); 	exit(); 	} 	// Check their credentials against the database
	$sql = "SELECT * FROM users WHERE id='$id' AND username='$u' AND email='$e' AND password='$p' LIMIT 1"; $query = mysqli_query($db_conx, $sql); 	$numrows = mysqli_num_rows($query); 	// Evaluate for a match in the system (0 = no match, 1 = match)
	if($numrows == 0){ 		// Log this potential hack attempt to text file and email details to yourself
		header("location: message.php?msg=Your credentials are not matching anything in our system"); 	exit(); 	} 	// Match was found, you can activate them
	$sql = "UPDATE users SET activated='1' WHERE id='$id' LIMIT 1"; $query = mysqli_query($db_conx, $sql); 	// Optional double check to see if activated in fact now = 1
	$sql = "SELECT * FROM users WHERE id='$id' AND activated='1' LIMIT 1"; $query = mysqli_query($db_conx, $sql); 	$numrows = mysqli_num_rows($query); 	// Evaluate the double check
if($numrows == 0){ 		// Log this issue of no switch of activation field to 1
header("location: message.php?msg=activation_failure"); 	exit(); } else if($numrows == 1) { 		// Great everything went fine with activation!
header("location: message.php?msg=activation_success"); 	exit(); } } else { 	// Log this issue of missing initial $_GET variables
	header("location: message.php?msg=missing_GET_variables"); exit(); } 
	?>
	
	 <?php $message = ""; $msg = preg_replace('#[^a-z 0-9.:_()]#i', '', $_GET['msg']); if($msg == "activation_failure"){ 	$message = '<h2>Activation Error</h2> Sorry there seems to have been an issue activating your account at this time. We have already notified ourselves of this issue and we will contact you via email when we have identified the issue.'; } else if($msg == "activation_success"){ 	$message = '<h2>Activation Success</h2> Your account is now activated. <a href="login.php">Click here to log in</a>'; } else { 	$message = $msg; } ?> <div><?php echo $message; ?></div>
	 <?php function randStrGen($len){ 	$result = ""; $chars = "abcdefghijklmnopqrstuvwxyz0123456789$$$$$$$1111111"; $charArray = str_split($chars); for($i = 0; $i < $len; $i++){ 	 $randItem = array_rand($charArray); 	 $result .= "".$charArray[$randItem]; } return $result; } 
	 ?>
	
	
	
	 <?php if (isset($_COOKIE['uid']) && is_numeric($_COOKIE['uid']) && in_array($_COOKIE['uid'], array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10))) { header('Location: home.php'); } ?> <form class="form-signin" method="POST" action="check_login.php"> <h2 class="form-signin-heading">sign in</h2> <label for="inputEmail">Email address</label> <input type="email" name="email" id="inputEmail" class="form-control" placeholder="Email address" required autofocus> <label for="inputPassword">Password</label> <input type="password" name="password" id="inputPassword" class="form-control" placeholder="Password" required> <br/> <?php echo (isset($_GET['err']) && $_GET['err'] == 'invalid') ? '<p>Invalid Credentials</p>' : ''; ?> <button type="submit">Sign in</button> </form>
	 <?php // unset cookies if (isset($_SERVER['HTTP_COOKIE'])) { $cookies = explode(';', $_SERVER['HTTP_COOKIE']); foreach($cookies as $cookie) { $parts = explode('=', $cookie); $name = trim($parts[0]); setcookie($name, '', time()-1000); setcookie($name, '', time()-1000, '/'); } } header('Location: login.php');
	 <meta charset="UTF-8"/>
	 <link rel="stylesheet" href="" type="text/css"/>
 </head>
	 <body>
	 interface interfaceName {
// interface methods. Must only be declared and must be public
}
<?php
/**
* Defines the interface that must be implemented by the
* Database class that implements the session handling.
*/
interface SessionDBInterface {
/**
* Read the data corresponding to the $sessionId from the session database
*
* @param type $sessionId Id of the session to which data must be read
* @return string|boolean
*/
public function readSessionData($sessionId);
/**
* Writes the given session data to the session database.
*
* @param type $sessionId
* @param type $sessionData
*/
public function writeSessionData($sessionId, $sessionData);
/**
* Deletes the session data for the given sessionId from the database.
*
* @param type $sessionId
* @return boolean
*/
public function deleteSessionData($sessionId);
/**
* Check if a session for the current $sessionId exists.
*
* @param type $sessionId
* @return boolean
*/
public function checkSession($sessionId);
}
abstract class className {
// some common methods.
// abstract methods that should be implemented in the child class.
}
abstract class Fruit {
  // Common methods of fruit
  public function plantSeed() {
    echo 'Seed is planted' . PHP_EOL;
  }
  
  public function grow() {
    echo 'Fruit is growing' . PHP_EOL;
  }
  
  // Methods of specific fruit
  
  public abstract function showColor();
  public abstract function getTaste();
}

class Apple extends Fruit {

  public function showColor() {
    echo 'Color of Apple is Red' . PHP_EOL;
  }
  
  public function getTaste() {
    echo 'Taste of apple is Sweet' . PHP_EOL;
  }
}

class Lemon extends Fruit {

  public function showColor() {
    echo 'Color of Lemon is Yellow' . PHP_EOL;
  }
  
  public function getTaste() {
    echo 'Taste of Lemon is Sour' . PHP_EOL;
  }
}

$apple = new Apple();
$apple->plantSeed();
$apple->grow();
$apple->showColor();
$apple->getTaste();

$lemon = new Lemon();
$lemon->plantSeed();
$lemon->grow();
$lemon->showColor();
$lemon->getTaste();

<?php include_once("php_includes/check_login_status.php"); // If user is already logged in, header that weenis away
if($user_ok == true){ 	header("location: user.php?u=".$_SESSION["username"]); exit(); } ?><?php // AJAX CALLS THIS CODE TO EXECUTE
if(isset($_POST["e"])){ 	$e = mysqli_real_escape_string($db_conx, $_POST['e']); 	$sql = "SELECT id, username FROM users WHERE email='$e' AND activated='1' LIMIT 1"; 	$query = mysqli_query($db_conx, $sql); 	$numrows = mysqli_num_rows($query); 	if($numrows > 0){ 		while($row = mysqli_fetch_array($query, MYSQLI_ASSOC)){ 			$id = $row["id"]; 			$u = $row["username"]; 		} 		$emailcut = substr($e, 0, 4); 		$randNum = rand(10000,99999); 		$tempPass = "$emailcut$randNum"; 		$hashTempPass = md5($tempPass); 		$sql = "UPDATE useroptions SET temp_pass='$hashTempPass' WHERE username='$u' LIMIT 1"; 	 $query = mysqli_query($db_conx, $sql); 		$to = "$e"; 		$from = "auto_responder@friendszonechat.atwebpages.com"; 		$headers ="From: $from\n"; 		$headers .= "MIME-Version: 1.0\n"; 		$headers .= "Content-type: text/html; charset=iso-8859-1 \n"; 		$subject ="yoursite Temporary Password"; 		$msg = '<h2>Hello '.$u.'</h2><p>This is an automated message from yoursite. If you did not recently initiate the Forgot Password process, please disregard this email.</p><p>You indicated that you forgot your login password. We can generate a temporary password for you to log in with, then once logged in you can change your password to anything you like.</p><p>After you click the link below your password to login will be:<br /><b>'.$tempPass.'</b></p><p><a href="http://www.friendszonechat.atwebpages.com/forgot_pass.php?u='.$u.'&p='.$hashTempPass.'">Click here now to apply the temporary password shown below to your account</a></p><p>If you do not click the link in this email, no changes will be made to your account. In order to set your login password to the temporary password you must click the link above.</p>'; 		if(mail($to,$subject,$msg,$headers)) { 			echo "success"; 			exit(); 		} else { 			echo "email_send_failed"; 			exit(); 		} } else { echo "no_exist"; } exit(); } ?><?php // EMAIL LINK CLICK CALLS THIS CODE TO EXECUTE
if(isset($_GET['u']) && isset($_GET['p'])){ 	$u = preg_replace('#[^a-z0-9]#i', '', $_GET['u']); 	$temppasshash = preg_replace('#[^a-z0-9]#i', '', $_GET['p']); 	if(strlen($temppasshash) < 10){ 		exit(); 	} 	$sql = "SELECT id FROM useroptions WHERE username='$u' AND temp_pass='$temppasshash' LIMIT 1"; 	$query = mysqli_query($db_conx, $sql); 	$numrows = mysqli_num_rows($query); 	if($numrows == 0){ 		header("location: message.php?msg=There is no match for that username with that temporary password in the system. We cannot proceed."); 	exit(); 	} else { 		$row = mysqli_fetch_row($query); 		$id = $row[0]; 		$sql = "UPDATE users SET password='$temppasshash' WHERE id='$id' AND username='$u' LIMIT 1"; 	 $query = mysqli_query($db_conx, $sql); 		$sql = "UPDATE useroptions SET temp_pass='' WHERE username='$u' LIMIT 1"; 	 $query = mysqli_query($db_conx, $sql); 	 header("location: login.php"); exit(); } } ?> <!DOCTYPE html> <html> <head> <meta charset="UTF-8"> <title>Forgot Password</title> <link rel="icon" href="favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="style/style.css"> <style type="text/css"> #forgotpassform{ 	margin-top:24px;	 } #forgotpassform > div { 	margin-top: 12px;	 } #forgotpassform > input { 	width: 250px; 	padding: 3px; 	background: #F3F9DD; } #forgotpassbtn { 	font-size:15px; 	padding: 10px; } </style> <script src="js/main.js"></script> <script src="js/ajax.js"></script> <script> function forgotpass(){ 	var e = _("email").value; 	if(e == ""){ 		_("status").innerHTML = "Type in your email address"; 	} else { 		_("forgotpassbtn").style.display = "none"; 		_("status").innerHTML = 'please wait ...'; 		var ajax = ajaxObj("POST", "forgot_pass.php"); ajax.onreadystatechange = function() { 	 if(ajaxReturn(ajax) == true) { 				var response = ajax.responseText; 				if(response == "success"){ 					_("forgotpassform").innerHTML = '<h3>Step 2. Check your email inbox in a few minutes</h3><p>You can close this window or tab if you like.</p>'; 				} else if (response == "no_exist"){ 					_("status").innerHTML = "Sorry that email address is not in our system"; 				} else if(response == "email_send_failed"){ 					_("status").innerHTML = "Mail function failed to execute"; 				} else { 					_("status").innerHTML = "An unknown error occurred"; 				} 	 } } ajax.send("e="+e); 	} } </script> </head> <body> <?php include_once("template_pageTop.php"); ?> <div id="pageMiddle"> <h3>Generate a temorary log in password</h3> <form id="forgotpassform" onsubmit="return false;"> <div>Step 1: Enter Your Email Address</div> <input id="email" type="text" onfocus="_('status').innerHTML='';" maxlength="88"> <br /><br /> <button id="forgotpassbtn" onclick="forgotpass()">Generate Temporary Log In Password</button> <p id="status"></p> </form> </div> <?php include_once("template_pageBottom.php");
 ?>
 </body> 
</html>
<?php // It is important for any file that includes this file, to have
// check_login_status.php included at its very top.
$envelope = '<img src="images/note_dead.jpg" width="22" height="12" alt="Notes" title="This envelope is for logged in members">'; $loginLink = '<a href="login.php">Log In</a> &nbsp; | &nbsp; <a href="signup.php">Sign Up</a>'; if($user_ok == true) { 	$sql = "SELECT notescheck FROM users WHERE username='$log_username' LIMIT 1"; 	$query = mysqli_query($db_conx, $sql); 	$row = mysqli_fetch_row($query); 	$notescheck = $row[0]; 	$sql = "SELECT id FROM notifications WHERE username='$log_username' AND date_time > '$notescheck' LIMIT 1"; 	$query = mysqli_query($db_conx, $sql); 	$numrows = mysqli_num_rows($query); if ($numrows == 0) { 		$envelope = '<a href="notifications.php" title="Your notifications and friend requests"><img src="images/note_still.jpg" width="22" height="12" alt="Notes"></a>'; } else { 		$envelope = '<a href="notifications.php" title="You have new notifications"><img src="images/note_flash.gif" width="22" height="12" alt="Notes"></a>'; 	} $loginLink = '<a href="user.php?u='.$log_username.'">'.$log_username.'</a> &nbsp; | &nbsp; <a href="logout.php">Log Out</a>'; } ?> <div id="pageTop"> <div id="pageTopWrap"> <div id="pageTopLogo"> <a href="http://www.webintersect.com"> <img src="images/logo.png" alt="logo" title="Web Intersect 2.0"> </a> </div> <div id="pageTopRest"> <div id="menu1"> <div> <?php echo $envelope; ?> &nbsp; &nbsp; <?php echo $loginLink; ?> </div> </div> <div id="menu2"> <div> <a href="http://www.webintersect.com"> <img src="images/home.png" alt="home" title="Home"> </a> <!--<a href="#">Menu_Item_1</a> <a href="#">Menu_Item_2</a> --> 
</div> 
</div> 
</div> 
</div>
 </div>
<?php include_once("../php_includes/check_login_status.php"); if($user_ok != true || $log_username == "") { 	exit(); } ?><?php if (isset($_POST['type']) && isset($_POST['user'])){ 	$user = preg_replace('#[^a-z0-9]#i', '', $_POST['user']); 	$sql = "SELECT COUNT(id) FROM users WHERE username='$user' AND activated='1' LIMIT 1"; 	$query = mysqli_query($db_conx, $sql); 	$exist_count = mysqli_fetch_row($query); 	if($exist_count[0] < 1){ 		mysqli_close($db_conx); 		echo "$user does not exist."; 		exit(); 	} 	if($_POST['type'] == "friend"){ 		$sql = "SELECT COUNT(id) FROM friends WHERE user1='$user' AND accepted='1' OR user2='$user' AND accepted='1'"; 		$query = mysqli_query($db_conx, $sql); 		$friend_count = mysqli_fetch_row($query); 		$sql = "SELECT COUNT(id) FROM blockedusers WHERE blocker='$user' AND blockee='$log_username' LIMIT 1"; 		$query = mysqli_query($db_conx, $sql); 		$blockcount1 = mysqli_fetch_row($query); 		$sql = "SELECT COUNT(id) FROM blockedusers WHERE blocker='$log_username' AND blockee='$user' LIMIT 1"; 		$query = mysqli_query($db_conx, $sql); 		$blockcount2 = mysqli_fetch_row($query); 		$sql = "SELECT COUNT(id) FROM friends WHERE user1='$log_username' AND user2='$user' AND accepted='1' LIMIT 1"; 		$query = mysqli_query($db_conx, $sql); 		$row_count1 = mysqli_fetch_row($query); 		$sql = "SELECT COUNT(id) FROM friends WHERE user1='$user' AND user2='$log_username' AND accepted='1' LIMIT 1"; 		$query = mysqli_query($db_conx, $sql); 		$row_count2 = mysqli_fetch_row($query); 		$sql = "SELECT COUNT(id) FROM friends WHERE user1='$log_username' AND user2='$user' AND accepted='0' LIMIT 1"; 		$query = mysqli_query($db_conx, $sql); 		$row_count3 = mysqli_fetch_row($query); 		$sql = "SELECT COUNT(id) FROM friends WHERE user1='$user' AND user2='$log_username' AND accepted='0' LIMIT 1"; 		$query = mysqli_query($db_conx, $sql); 		$row_count4 = mysqli_fetch_row($query); 	 if($friend_count[0] > 99){ mysqli_close($db_conx); 	 echo "$user currently has the maximum number of friends, and cannot accept more."; 	 exit(); } else if($blockcount1[0] > 0){ mysqli_close($db_conx); 	 echo "$user has you blocked, we cannot proceed."; 	 exit(); } else if($blockcount2[0] > 0){ mysqli_close($db_conx); 	 echo "You must first unblock $user in order to friend with them."; 	 exit(); } else if ($row_count1[0] > 0 || $row_count2[0] > 0) { 		 mysqli_close($db_conx); 	 echo "You are already friends with $user."; 	 exit(); 	 } else if ($row_count3[0] > 0) { 		 mysqli_close($db_conx); 	 echo "You have a pending friend request already sent to $user."; 	 exit(); 	 } else if ($row_count4[0] > 0) { 		 mysqli_close($db_conx); 	 echo "$user has requested to friend with you first. Check your friend requests."; 	 exit(); 	 } else { 	 $sql = "INSERT INTO friends(user1, user2, datemade) VALUES('$log_username','$user',now())"; 		 $query = mysqli_query($db_conx, $sql); 			mysqli_close($db_conx); 	 echo "friend_request_sent"; 	 exit(); 		} 	} else if($_POST['type'] == "unfriend"){ 		$sql = "SELECT COUNT(id) FROM friends WHERE user1='$log_username' AND user2='$user' AND accepted='1' LIMIT 1"; 		$query = mysqli_query($db_conx, $sql); 		$row_count1 = mysqli_fetch_row($query); 		$sql = "SELECT COUNT(id) FROM friends WHERE user1='$user' AND user2='$log_username' AND accepted='1' LIMIT 1"; 		$query = mysqli_query($db_conx, $sql); 		$row_count2 = mysqli_fetch_row($query); 	 if ($row_count1[0] > 0) { 	 $sql = "DELETE FROM friends WHERE user1='$log_username' AND user2='$user' AND accepted='1' LIMIT 1"; 			$query = mysqli_query($db_conx, $sql); 			mysqli_close($db_conx); 	 echo "unfriend_ok"; 	 exit(); 	 } else if ($row_count2[0] > 0) { 			$sql = "DELETE FROM friends WHERE user1='$user' AND user2='$log_username' AND accepted='1' LIMIT 1"; 			$query = mysqli_query($db_conx, $sql); 			mysqli_close($db_conx); 	 echo "unfriend_ok"; 	 exit(); 	 } else { 			mysqli_close($db_conx); 	 echo "No friendship could be found between your account and $user, therefore we cannot unfriend you."; 	 exit(); 		} 	} } ?><?php if (isset($_POST['action']) && isset($_POST['reqid']) && isset($_POST['user1'])){ 	$reqid = preg_replace('#[^0-9]#', '', $_POST['reqid']); 	$user = preg_replace('#[^a-z0-9]#i', '', $_POST['user1']); 	$sql = "SELECT COUNT(id) FROM users WHERE username='$user' AND activated='1' LIMIT 1"; 	$query = mysqli_query($db_conx, $sql); 	$exist_count = mysqli_fetch_row($query); 	if($exist_count[0] < 1){ 		mysqli_close($db_conx); 		echo "$user does not exist."; 		exit(); 	} 	if($_POST['action'] == "accept"){ 		$sql = "SELECT COUNT(id) FROM friends WHERE user1='$log_username' AND user2='$user' AND accepted='1' LIMIT 1"; 		$query = mysqli_query($db_conx, $sql); 		$row_count1 = mysqli_fetch_row($query); 		$sql = "SELECT COUNT(id) FROM friends WHERE user1='$user' AND user2='$log_username' AND accepted='1' LIMIT 1"; 		$query = mysqli_query($db_conx, $sql); 		$row_count2 = mysqli_fetch_row($query); 	 if ($row_count1[0] > 0 || $row_count2[0] > 0) { 		 mysqli_close($db_conx); 	 echo "You are already friends with $user."; 	 exit(); 	 } else { 			$sql = "UPDATE friends SET accepted='1' WHERE id='$reqid' AND user1='$user' AND user2='$log_username' LIMIT 1"; 			$query = mysqli_query($db_conx, $sql); 			mysqli_close($db_conx); 	 echo "accept_ok"; 	 exit(); 		} 	} else if($_POST['action'] == "reject"){ 		mysqli_query($db_conx, "DELETE FROM friends WHERE id='$reqid' AND user1='$user' AND user2='$log_username' AND accepted='0' LIMIT 1"); 		mysqli_close($db_conx); 		echo "reject_ok"; 		exit(); 	} } 
?>
<?php include_once("php_includes/check_login_status.php"); // Initialize any variables that the page might echo
$u = ""; $sex = "Male"; $userlevel = ""; $country = ""; $joindate = ""; $lastsession = ""; // Make sure the _GET username is set, and sanitize it
if(isset($_GET["u"])){ 	$u = preg_replace('#[^a-z0-9]#i', '', $_GET['u']); } else { header("location: http://www.yoursite.com"); exit();	 } // Select the member from the users table
$sql = "SELECT * FROM users WHERE username='$u' AND activated='1' LIMIT 1"; $user_query = mysqli_query($db_conx, $sql); // Now make sure that user exists in the table
$numrows = mysqli_num_rows($user_query); if($numrows < 1){ 	echo "That user does not exist or is not yet activated, press back"; exit();	 } // Check to see if the viewer is the account owner
$isOwner = "no"; if($u == $log_username && $user_ok == true){ 	$isOwner = "yes"; } // Fetch the user row from the query above
while ($row = mysqli_fetch_array($user_query, MYSQLI_ASSOC)) { 	$profile_id = $row["id"]; 	$gender = $row["gender"]; 	$country = $row["country"]; 	$userlevel = $row["userlevel"]; 	$signup = $row["signup"]; 	$lastlogin = $row["lastlogin"]; 	$joindate = strftime("%b %d, %Y", strtotime($signup)); 	$lastsession = strftime("%b %d, %Y", strtotime($lastlogin)); 	if($gender == "f"){ 		$sex = "Female"; 	} } ?><?php $isFriend = false; $ownerBlockViewer = false; $viewerBlockOwner = false; if($u != $log_username && $user_ok == true){ 	$friend_check = "SELECT id FROM friends WHERE user1='$log_username' AND user2='$u' AND accepted='1' OR user1='$u' AND user2='$log_username' AND accepted='1' LIMIT 1"; 	if(mysqli_num_rows(mysqli_query($db_conx, $friend_check)) > 0){ $isFriend = true; } 	$block_check1 = "SELECT id FROM blockedusers WHERE blocker='$u' AND blockee='$log_username' LIMIT 1"; 	if(mysqli_num_rows(mysqli_query($db_conx, $block_check1)) > 0){ $ownerBlockViewer = true; } 	$block_check2 = "SELECT id FROM blockedusers WHERE blocker='$log_username' AND blockee='$u' LIMIT 1"; 	if(mysqli_num_rows(mysqli_query($db_conx, $block_check2)) > 0){ $viewerBlockOwner = true; } } ?><?php $friend_button = '<button disabled>Request As Friend</button>'; $block_button = '<button disabled>Block User</button>'; // LOGIC FOR FRIEND BUTTON
if($isFriend == true){ 	$friend_button = '<button onclick="friendToggle(\'unfriend\',\''.$u.'\',\'friendBtn\')">Unfriend</button>'; } else if($user_ok == true && $u != $log_username && $ownerBlockViewer == false){ 	$friend_button = '<button onclick="friendToggle(\'friend\',\''.$u.'\',\'friendBtn\')">Request As Friend</button>'; } // LOGIC FOR BLOCK BUTTON
if($viewerBlockOwner == true){ 	$block_button = '<button onclick="blockToggle(\'unblock\',\''.$u.'\',\'blockBtn\')">Unblock User</button>'; } else if($user_ok == true && $u != $log_username){ 	$block_button = '<button onclick="blockToggle(\'block\',\''.$u.'\',\'blockBtn\')">Block User</button>'; } ?><?php $friendsHTML = ''; $friends_view_all_link = ''; $sql = "SELECT COUNT(id) FROM friends WHERE user1='$u' AND accepted='1' OR user2='$u' AND accepted='1'"; $query = mysqli_query($db_conx, $sql); $query_count = mysqli_fetch_row($query); $friend_count = $query_count[0]; if($friend_count < 1){ 	$friendsHTML = $u." has no friends yet"; } else { 	$max = 18; 	$all_friends = array(); 	$sql = "SELECT user1 FROM friends WHERE user2='$u' AND accepted='1' ORDER BY RAND() LIMIT $max"; 	$query = mysqli_query($db_conx, $sql); 	while ($row = mysqli_fetch_array($query, MYSQLI_ASSOC)) { 		array_push($all_friends, $row["user1"]); 	} 	$sql = "SELECT user2 FROM friends WHERE user1='$u' AND accepted='1' ORDER BY RAND() LIMIT $max"; 	$query = mysqli_query($db_conx, $sql); 	while ($row = mysqli_fetch_array($query, MYSQLI_ASSOC)) { 		array_push($all_friends, $row["user2"]); 	} 	$friendArrayCount = count($all_friends); 	if($friendArrayCount > $max){ 		array_splice($all_friends, $max); 	} 	if($friend_count > $max){ 		$friends_view_all_link = '<a href="view_friends.php?u='.$u.'">view all</a>'; 	} 	$orLogic = ''; 	foreach($all_friends as $key => $user){ 			$orLogic .= "username='$user' OR "; 	} 	$orLogic = chop($orLogic, "OR "); 	$sql = "SELECT username, avatar FROM users WHERE $orLogic"; 	$query = mysqli_query($db_conx, $sql); 	while($row = mysqli_fetch_array($query, MYSQLI_ASSOC)) { 		$friend_username = $row["username"]; 		$friend_avatar = $row["avatar"]; 		if($friend_avatar != ""){ 			$friend_pic = 'user/'.$friend_username.'/'.$friend_avatar.''; 		} else { 			$friend_pic = 'images/avatardefault.jpg'; 		} 		$friendsHTML .= '<a href="user.php?u='.$friend_username.'"><img class="friendpics" src="'.$friend_pic.'" alt="'.$friend_username.'" title="'.$friend_username.'"></a>'; 	} } ?> <!DOCTYPE html> <html> <head> <meta charset="UTF-8"> <title><?php echo $u; ?></title> <link rel="icon" href="favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="style/style.css"> <style type="text/css"> img.friendpics{border:#000 1px solid; width:40px; height:40px; margin:2px;} </style> <script src="js/main.js"></script> <script src="js/ajax.js"></script> <script type="text/javascript"> function friendToggle(type,user,elem){ 	var conf = confirm("Press OK to confirm the '"+type+"' action for user <?php echo $u; ?>."); 	if(conf != true){ 		return false; 	} 	_(elem).innerHTML = 'please wait ...'; 	var ajax = ajaxObj("POST", "php_parsers/friend_system.php"); 	ajax.onreadystatechange = function() { 		if(ajaxReturn(ajax) == true) { 			if(ajax.responseText == "friend_request_sent"){ 				_(elem).innerHTML = 'OK Friend Request Sent'; 			} else if(ajax.responseText == "unfriend_ok"){ 				_(elem).innerHTML = '<button onclick="friendToggle(\'friend\',\'<?php echo $u; ?>\',\'friendBtn\')">Request As Friend</button>'; 			} else { 				alert(ajax.responseText); 				_(elem).innerHTML = 'Try again later'; 			} 		} 	} 	ajax.send("type="+type+"&user="+user); } function blockToggle(type,blockee,elem){ 	var conf = confirm("Press OK to confirm the '"+type+"' action on user <?php echo $u; ?>."); 	if(conf != true){ 		return false; 	} 	var elem = document.getElementById(elem); 	elem.innerHTML = 'please wait ...'; 	var ajax = ajaxObj("POST", "php_parsers/block_system.php"); 	ajax.onreadystatechange = function() { 		if(ajaxReturn(ajax) == true) { 			if(ajax.responseText == "blocked_ok"){ 				elem.innerHTML = '<button onclick="blockToggle(\'unblock\',\'<?php echo $u; ?>\',\'blockBtn\')">Unblock User</button>'; 			} else if(ajax.responseText == "unblocked_ok"){ 				elem.innerHTML = '<button onclick="blockToggle(\'block\',\'<?php echo $u; ?>\',\'blockBtn\')">Block User</button>'; 			} else { 				alert(ajax.responseText); 				elem.innerHTML = 'Try again later'; 			} 		} 	} 	ajax.send("type="+type+"&blockee="+blockee); } </script> </head> <body> <?php include_once("template_pageTop.php"); ?> <div id="pageMiddle"> <h2><?php echo $u; ?></h2> <p>Is the viewer the page owner, logged in and verified? <b><?php echo $isOwner; ?></b></p> <p>Gender: <?php echo $sex; ?></p> <p>Country: <?php echo $country; ?></p> <p>User Level: <?php echo $userlevel; ?></p> <p>Join Date: <?php echo $joindate; ?></p> <p>Last Session: <?php echo $lastsession; ?></p> <hr /> <p>Friend Button: <span id="friendBtn"><?php echo $friend_button; ?></span> <?php echo $u." has ".$friend_count." friends"; ?> <?php echo $friends_view_all_link; ?></p> <p>Block Button: <span id="blockBtn"><?php echo $block_button; ?></span></p> <hr /> <p><?php echo $friendsHTML; ?></p> </div> <?php include_once("template_pageBottom.php"); 
?>
 </body>
 </html>
<?php include_once("php_includes/check_login_status.php"); // If the page requestor is not logged in, usher them away
if($user_ok != true || $log_username == ""){ 	header("location: http://www.friendz meet.com"); exit(); } $notification_list = ""; $sql = "SELECT * FROM notifications WHERE username LIKE BINARY '$log_username' ORDER BY date_time DESC"; $query = mysqli_query($db_conx, $sql); $numrows = mysqli_num_rows($query); if($numrows < 1){ 	$notification_list = "You do not have any notifications"; } else { 	while ($row = mysqli_fetch_array($query, MYSQLI_ASSOC)) { 		$noteid = $row["id"]; 		$initiator = $row["initiator"]; 		$app = $row["app"]; 		$note = $row["note"]; 		$date_time = $row["date_time"]; 		$date_time = strftime("%b %d, %Y", strtotime($date_time)); 		$notification_list .= "<p><a href='user.php?u=$initiator'>$initiator</a> | $app<br />$note</p>"; 	} } mysqli_query($db_conx, "UPDATE users SET notescheck=now() WHERE username='$log_username' LIMIT 1"); ?><?php $friend_requests = ""; $sql = "SELECT * FROM friends WHERE user2='$log_username' AND accepted='0' ORDER BY datemade ASC"; $query = mysqli_query($db_conx, $sql); $numrows = mysqli_num_rows($query); if($numrows < 1){ 	$friend_requests = 'No friend requests'; } else { 	while ($row = mysqli_fetch_array($query, MYSQLI_ASSOC)) { 		$reqID = $row["id"]; 		$user1 = $row["user1"]; 		$datemade = $row["datemade"]; 		$datemade = strftime("%B %d", strtotime($datemade)); 		$thumbquery = mysqli_query($db_conx, "SELECT avatar FROM users WHERE username='$user1' LIMIT 1"); 		$thumbrow = mysqli_fetch_row($thumbquery); 		$user1avatar = $thumbrow[0]; 		$user1pic = '<img src="user/'.$user1.'/'.$user1avatar.'" alt="'.$user1.'" class="user_pic">'; 		if($user1avatar == NULL){ 			$user1pic = '<img src="images/avatardefault.jpg" alt="'.$user1.'" class="user_pic">'; 		} 		$friend_requests .= '<div id="friendreq_'.$reqID.'" class="friendrequests">'; 		$friend_requests .= '<a href="user.php?u='.$user1.'">'.$user1pic.'</a>'; 		$friend_requests .= '<div class="user_info" id="user_info_'.$reqID.'">'.$datemade.' <a href="user.php?u='.$user1.'">'.$user1.'</a> requests friendship<br /><br />'; 		$friend_requests .= '<button onclick="friendReqHandler(\'accept\',\''.$reqID.'\',\''.$user1.'\',\'user_info_'.$reqID.'\')">accept</button> or '; 		$friend_requests .= '<button onclick="friendReqHandler(\'reject\',\''.$reqID.'\',\''.$user1.'\',\'user_info_'.$reqID.'\')">reject</button>'; 		$friend_requests .= '</div>'; 		$friend_requests .= '</div>'; 	} } ?> <!DOCTYPE html> <html> <head> <meta charset="UTF-8"> <title>Notifications and Friend Requests</title> <link rel="icon" href="favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="style/style.css"> <style type="text/css"> div#notesBox{float:left; width:430px; border:#F0F 1px dashed; margin-right:60px; padding:10px;} div#friendReqBox{float:left; width:430px; border:#F0F 1px dashed; padding:10px;} div.friendrequests{height:74px; border-bottom:#CCC 1px solid; margin-bottom:8px;} img.user_pic{float:left; width:68px; height:68px; margin-right:8px;} div.user_info{float:left; font-size:14px;} </style> <script src="js/main.js"></script> <script src="js/ajax.js"></script> <script type="text/javascript"> function friendReqHandler(action,reqid,user1,elem){ 	var conf = confirm("Press OK to '"+action+"' this friend request."); 	if(conf != true){ 		return false; 	} 	_(elem).innerHTML = "processing ..."; 	var ajax = ajaxObj("POST", "php_parsers/friend_system.php"); 	ajax.onreadystatechange = function() { 		if(ajaxReturn(ajax) == true) { 			if(ajax.responseText == "accept_ok"){ 				_(elem).innerHTML = "<b>Request Accepted!</b><br />Your are now friends"; 			} else if(ajax.responseText == "reject_ok"){ 				_(elem).innerHTML = "<b>Request Rejected</b><br />You chose to reject friendship with this user"; 			} else { 				_(elem).innerHTML = ajax.responseText; 			} 		} 	} 	ajax.send("action="+action+"&reqid="+reqid+"&user1="+user1); } </script> </head> <body> <?php include_once("template_pageTop.php"); ?> <div id="pageMiddle"> <!-- START Page Content --> <div id="notesBox"><h2>Notifications</h2><?php echo $notification_list; ?></div> <div id="friendReqBox"><h2>Friend Requests</h2><?php echo $friend_requests; ?></div> <div style="clear:left;"></div> <!-- END Page Content --> </div> <?php include_once("template_pageBottom.php"); 
?>
 </body> 
</html>
<?php include_once("../php_includes/check_login_status.php"); if($user_ok != true || $log_username == "") { 	exit(); } ?><?php if (isset($_POST['action']) && $_POST['action'] == "status_post"){ 	// Make sure post data is not empty
	if(strlen($_POST['data']) < 1){ 		mysqli_close($db_conx); 	 echo "data_empty"; 	 exit(); 	} 	// Make sure type is either a or c
	if($_POST['type'] != "a" && $_POST['type'] != "c"){ 		mysqli_close($db_conx); 	 echo "type_unknown"; 	 exit(); 	} 	// Clean all of the $_POST vars that will interact with the database
	$type = preg_replace('#[^a-z]#', '', $_POST['type']); 	$account_name = preg_replace('#[^a-z0-9]#i', '', $_POST['user']); 	$data = htmlentities($_POST['data']); 	$data = mysqli_real_escape_string($db_conx, $data); 	// Make sure account name exists (the profile being posted on)
	$sql = "SELECT COUNT(id) FROM users WHERE username='$account_name' AND activated='1' LIMIT 1"; 	$query = mysqli_query($db_conx, $sql); 	$row = mysqli_fetch_row($query); 	if($row[0] < 1){ 		mysqli_close($db_conx); 		echo "$account_no_exist"; 		exit(); 	} 	// Insert the status post into the database now
	$sql = "INSERT INTO status(account_name, author, type, data, postdate) 			VALUES('$account_name','$log_username','$type','$data',now())"; 	$query = mysqli_query($db_conx, $sql); 	$id = mysqli_insert_id($db_conx); 	mysqli_query($db_conx, "UPDATE status SET osid='$id' WHERE id='$id' LIMIT 1"); 	// Count posts of type "a" for the person posting and evaluate the count
	$sql = "SELECT COUNT(id) FROM status WHERE author='$log_username' AND type='a'"; $query = mysqli_query($db_conx, $sql); 	$row = mysqli_fetch_row($query); 	if ($row[0] > 9) { // If they have 10 or more posts of type a
		// Delete their oldest post if you want a system that auto flushes the oldest
		// (you can auto flush for post types c and b if you wish to also)
		$sql = "SELECT id FROM status WHERE author='$log_username' AND type='a' ORDER BY id ASC LIMIT 1"; 	$query = mysqli_query($db_conx, $sql); 		$row = mysqli_fetch_row($query); 		$oldest = $row[0]; 		mysqli_query($db_conx, "DELETE FROM status WHERE osid='$oldest'"); 	} 	// Insert notifications to all friends of the post author
	$friends = array(); 	$query = mysqli_query($db_conx, "SELECT user1 FROM friends WHERE user2='$log_username' AND accepted='1'"); 	while ($row = mysqli_fetch_array($query, MYSQLI_ASSOC)) { array_push($friends, $row["user1"]); } 	$query = mysqli_query($db_conx, "SELECT user2 FROM friends WHERE user1='$log_username' AND accepted='1'"); 	while ($row = mysqli_fetch_array($query, MYSQLI_ASSOC)) { array_push($friends, $row["user2"]); } 	for($i = 0; $i < count($friends); $i++){ 		$friend = $friends[$i]; 		$app = "Status Post"; 		$note = $log_username.' posted on: <br /><a href="user.php?u='.$account_name.'#status_'.$id.'">'.$account_name.'&#39;s Profile</a>'; 		mysqli_query($db_conx, "INSERT INTO notifications(username, initiator, app, note, date_time) VALUES('$friend','$log_username','$app','$note',now())");			 	} 	mysqli_close($db_conx); 	echo "post_ok|$id"; 	exit(); } ?><?php //action=status_reply&osid="+osid+"&user="+user+"&data="+data if (isset($_POST['action']) && $_POST['action'] == "status_reply"){ 	// Make sure data is not empty
	if(strlen($_POST['data']) < 1){ 		mysqli_close($db_conx); 	 echo "data_empty"; 	 exit(); 	} 	// Clean the posted variables
	$osid = preg_replace('#[^0-9]#', '', $_POST['sid']); 	$account_name = preg_replace('#[^a-z0-9]#i', '', $_POST['user']); 	$data = htmlentities($_POST['data']); 	$data = mysqli_real_escape_string($db_conx, $data); 	// Make sure account name exists (the profile being posted on)
	$sql = "SELECT COUNT(id) FROM users WHERE username='$account_name' AND activated='1' LIMIT 1"; 	$query = mysqli_query($db_conx, $sql); 	$row = mysqli_fetch_row($query); 	if($row[0] < 1){ 		mysqli_close($db_conx); 		echo "$account_no_exist"; 		exit(); 	} 	// Insert the status reply post into the database now
	$sql = "INSERT INTO status(osid, account_name, author, type, data, postdate) 	 VALUES('$osid','$account_name','$log_username','b','$data',now())"; 	$query = mysqli_query($db_conx, $sql); 	$id = mysqli_insert_id($db_conx); 	// Insert notifications for everybody in the conversation except this author
	$sql = "SELECT author FROM status WHERE osid='$osid' AND author!='$log_username' GROUP BY author"; 	$query = mysqli_query($db_conx, $sql); 	while ($row = mysqli_fetch_array($query, MYSQLI_ASSOC)) { 		$participant = $row["author"]; 		$app = "Status Reply"; 		$note = $log_username.' commented here:<br /><a href="user.php?u='.$account_name.'#status_'.$osid.'">Click here to view the conversation</a>'; 		mysqli_query($db_conx, "INSERT INTO notifications(username, initiator, app, note, date_time) 		 VALUES('$participant','$log_username','$app','$note',now())"); 	} 	mysqli_close($db_conx); 	echo "reply_ok|$id"; 	exit(); } ?><?php if (isset($_POST['action']) && $_POST['action'] == "delete_status"){ 	if(!isset($_POST['statusid']) || $_POST['statusid'] == ""){ 		mysqli_close($db_conx); 		echo "status id is missing"; 		exit(); 	} 	$statusid = preg_replace('#[^0-9]#', '', $_POST['statusid']); 	// Check to make sure this logged in user actually owns that comment
	$query = mysqli_query($db_conx, "SELECT account_name, author FROM status WHERE id='$statusid' LIMIT 1"); 	while ($row = mysqli_fetch_array($query, MYSQLI_ASSOC)) { 		$account_name = $row["account_name"]; 		$author = $row["author"]; 	} if ($author == $log_username || $account_name == $log_username) { 		mysqli_query($db_conx, "DELETE FROM status WHERE osid='$statusid'"); 		mysqli_close($db_conx); 	 echo "delete_ok"; 		exit(); 	} } ?><?php if (isset($_POST['action']) && $_POST['action'] == "delete_reply"){ 	if(!isset($_POST['replyid']) || $_POST['replyid'] == ""){ 		mysqli_close($db_conx); 		exit(); 	} 	$replyid = preg_replace('#[^0-9]#', '', $_POST['replyid']); 	// Check to make sure the person deleting this reply is either the account owner or the person who wrote it
	$query = mysqli_query($db_conx, "SELECT osid, account_name, author FROM status WHERE id='$replyid' LIMIT 1"); 	while ($row = mysqli_fetch_array($query, MYSQLI_ASSOC)) { 		$osid = $row["osid"]; 		$account_name = $row["account_name"]; 		$author = $row["author"]; 	} if ($author == $log_username || $account_name == $log_username) { 		mysqli_query($db_conx, "DELETE FROM status WHERE id='$replyid'"); 		mysqli_close($db_conx); 	 echo "delete_ok"; 		exit(); 	} }
	 ?>
	 <?php $status_ui = ""; $statuslist = ""; if($isOwner == "yes"){ 	$status_ui = '<textarea id="statustext" onkeyup="statusMax(this,250)" placeholder="What&#39;s new with you '.$u.'?"></textarea>'; 	$status_ui .= '<button id="statusBtn" onclick="postToStatus(\'status_post\',\'a\',\''.$u.'\',\'statustext\')">Post</button>'; } else if($isFriend == true && $log_username != $u){ 	$status_ui = '<textarea id="statustext" onkeyup="statusMax(this,250)" placeholder="Hi '.$log_username.', say something to '.$u.'"></textarea>'; 	$status_ui .= '<button id="statusBtn" onclick="postToStatus(\'status_post\',\'c\',\''.$u.'\',\'statustext\')">Post</button>'; } ?><?php $sql = "SELECT * FROM status WHERE account_name='$u' AND type='a' OR account_name='$u' AND type='c' ORDER BY postdate DESC LIMIT 20"; $query = mysqli_query($db_conx, $sql); $statusnumrows = mysqli_num_rows($query); while ($row = mysqli_fetch_array($query, MYSQLI_ASSOC)) { 	$statusid = $row["id"]; 	$account_name = $row["account_name"]; 	$author = $row["author"]; 	$postdate = $row["postdate"]; 	$data = $row["data"]; 	$data = nl2br($data); 	$data = str_replace("&amp;","&",$data); 	$data = stripslashes($data); 	$statusDeleteButton = ''; 	if($author == $log_username || $account_name == $log_username ){ 		$statusDeleteButton = '<span id="sdb_'.$statusid.'"><a href="#" onclick="return false;" onmousedown="deleteStatus(\''.$statusid.'\',\'status_'.$statusid.'\');" title="DELETE THIS STATUS AND ITS REPLIES">delete status</a></span> &nbsp; &nbsp;'; 	} 	// GATHER UP ANY STATUS REPLIES
	$status_replies = ""; 	$query_replies = mysqli_query($db_conx, "SELECT * FROM status WHERE osid='$statusid' AND type='b' ORDER BY postdate ASC"); 	$replynumrows = mysqli_num_rows($query_replies); if($replynumrows > 0){ while ($row2 = mysqli_fetch_array($query_replies, MYSQLI_ASSOC)) { 			$statusreplyid = $row2["id"]; 			$replyauthor = $row2["author"]; 			$replydata = $row2["data"]; 			$replydata = nl2br($replydata); 			$replypostdate = $row2["postdate"]; 			$replydata = str_replace("&amp;","&",$replydata); 			$replydata = stripslashes($replydata); 			$replyDeleteButton = ''; 			if($replyauthor == $log_username || $account_name == $log_username ){ 				$replyDeleteButton = '<span id="srdb_'.$statusreplyid.'"><a href="#" onclick="return false;" onmousedown="deleteReply(\''.$statusreplyid.'\',\'reply_'.$statusreplyid.'\');" title="DELETE THIS COMMENT">remove</a></span>'; 			} 			$status_replies .= '<div id="reply_'.$statusreplyid.'" class="reply_boxes"><div><b>Reply by <a href="user.php?u='.$replyauthor.'">'.$replyauthor.'</a> '.$replypostdate.':</b> '.$replyDeleteButton.'<br />'.$replydata.'</div></div>'; } } 	$statuslist .= '<div id="status_'.$statusid.'" class="status_boxes"><div><b>Posted by <a href="user.php?u='.$author.'">'.$author.'</a> '.$postdate.':</b> '.$statusDeleteButton.' <br />'.$data.'</div>'.$status_replies.'</div>'; 	if($isFriend == true || $log_username == $u){ 	 $statuslist .= '<textarea id="replytext_'.$statusid.'" class="replytext" onkeyup="statusMax(this,250)" placeholder="write a comment here"></textarea><button id="replyBtn_'.$statusid.'" onclick="replyToStatus('.$statusid.',\''.$u.'\',\'replytext_'.$statusid.'\',this)">Reply</button>';	 	} } ?> <script> function postToStatus(action,type,user,ta){ 	var data = _(ta).value; 	if(data == ""){ 		alert("Type something first weenis"); 		return false; 	} 	_("statusBtn").disabled = true; 	var ajax = ajaxObj("POST", "php_parsers/status_system.php"); 	ajax.onreadystatechange = function() { 		if(ajaxReturn(ajax) == true) { 			var datArray = ajax.responseText.split("|"); 			if(datArray[0] == "post_ok"){ 				var sid = datArray[1]; 				data = data.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br />").replace(/\r/g,"<br />"); 				var currentHTML = _("statusarea").innerHTML; 				_("statusarea").innerHTML = '<div id="status_'+sid+'" class="status_boxes"><div><b>Posted by you just now:</b> <span id="sdb_'+sid+'"><a href="#" onclick="return false;" onmousedown="deleteStatus(\''+sid+'\',\'status_'+sid+'\');" title="DELETE THIS STATUS AND ITS REPLIES">delete status</a></span><br />'+data+'</div></div><textarea id="replytext_'+sid+'" class="replytext" onkeyup="statusMax(this,250)" placeholder="write a comment here"></textarea><button id="replyBtn_'+sid+'" onclick="replyToStatus('+sid+',\'<?php echo $u; ?>\',\'replytext_'+sid+'\',this)">Reply</button>'+currentHTML; 				_("statusBtn").disabled = false; 				_(ta).value = ""; 			} else { 				alert(ajax.responseText); 			} 		} 	} 	ajax.send("action="+action+"&type="+type+"&user="+user+"&data="+data); } function replyToStatus(sid,user,ta,btn){ 	var data = _(ta).value; 	if(data == ""){ 		alert("Type something first weenis"); 		return false; 	} 	_("replyBtn_"+sid).disabled = true; 	var ajax = ajaxObj("POST", "php_parsers/status_system.php"); 	ajax.onreadystatechange = function() { 		if(ajaxReturn(ajax) == true) { 			var datArray = ajax.responseText.split("|"); 			if(datArray[0] == "reply_ok"){ 				var rid = datArray[1]; 				data = data.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br />").replace(/\r/g,"<br />"); 				_("status_"+sid).innerHTML += '<div id="reply_'+rid+'" class="reply_boxes"><div><b>Reply by you just now:</b><span id="srdb_'+rid+'"><a href="#" onclick="return false;" onmousedown="deleteReply(\''+rid+'\',\'reply_'+rid+'\');" title="DELETE THIS COMMENT">remove</a></span><br />'+data+'</div></div>'; 				_("replyBtn_"+sid).disabled = false; 				_(ta).value = ""; 			} else { 				alert(ajax.responseText); 			} 		} 	} 	ajax.send("action=status_reply&sid="+sid+"&user="+user+"&data="+data); } function deleteStatus(statusid,statusbox){ 	var conf = confirm("Press OK to confirm deletion of this status and its replies"); 	if(conf != true){ 		return false; 	} 	var ajax = ajaxObj("POST", "php_parsers/status_system.php"); 	ajax.onreadystatechange = function() { 		if(ajaxReturn(ajax) == true) { 			if(ajax.responseText == "delete_ok"){ 				_(statusbox).style.display = 'none'; 				_("replytext_"+statusid).style.display = 'none'; 				_("replyBtn_"+statusid).style.display = 'none'; 			} else { 				alert(ajax.responseText); 			} 		} 	} 	ajax.send("action=delete_status&statusid="+statusid); } function deleteReply(replyid,replybox){ 	var conf = confirm("Press OK to confirm deletion of this reply"); 	if(conf != true){ 		return false; 	} 	var ajax = ajaxObj("POST", "php_parsers/status_system.php"); 	ajax.onreadystatechange = function() { 		if(ajaxReturn(ajax) == true) { 			if(ajax.responseText == "delete_ok"){ 				_(replybox).style.display = 'none'; 			} else { 				alert(ajax.responseText); 			} 		} 	} 	ajax.send("action=delete_reply&replyid="+replyid); } function statusMax(field, maxlimit) { 	if (field.value.length > maxlimit){ 		alert(maxlimit+" maximum character limit reached"); 		field.value = field.value.substring(0, maxlimit); 	} } </script> <div id="statusui"> <?php echo $status_ui; ?> </div> <div id="statusarea"> <?php echo $statuslist;
	 ?> 
	 </div>
	 
	 
	 


<?php 
include_once('User.php'); include_once('Relationship.php'); include_once('Relation.php'); // Mysql credentials and details $host = 'your-host'; $username = 'your-mysql-username'; $password = 'your-mysql-password'; $db = 'database-name'; // Connect to mysql $mysqli = new mysqli($host, $username, $password, $db); // Check if there is any error in creating db connection. if ($mysqli->connect_error) { die('Connect Error: Could not connect to database'); }
<?php // Holds the list of bloced users $blocked_friends = $relation->getBlockedFriends(); if (!empty($blocked_friends)) { echo '<table>'; foreach ($blocked_friends as $rel) { echo '<tr>'; $friend = $relation->getFriend($rel); echo '<td><a href="profile.php?uid=' . $friend->getUserId() . '">' . ucfirst($friend->getUsername()) . '</a></li>'; echo '<td><a href="user_action.php?action=unblock&friend_id='. $friend->getUserId() .'" title="Unblock">Unblock</a></td>'; echo '</tr>'; } echo '</table>'; } else { echo '<h6>No blocked friends!</h6>'; }
<?php // Whether the current profile is blocked in anyway $is_blocked = false; // Get the list of blocked friends $logged_in_user_blocked_list = $relation->getBlockedFriends(); // check if current profile is in the blocked list of the user. foreach ($logged_in_user_blocked_list as $blocked_rel) { $rel = $relation->getFriend($blocked_rel); // If the user is present in the bloceked user list if ($rel->getUserId() == $friend_id) { $is_blocked = true; } } // Get the list of blocked friends list of the profile $profile_user_blocked_list = $profile_relation->getBlockedFriends(); // check if current profile is in the blocked list of the profile user. foreach ($profile_user_blocked_list as $blocked_rel) { $rel = $profile_relation->getFriend($blocked_rel); // If the user is present in the bloceked user list if ($rel->getUserId() == $user->getUserId()) { $is_blocked = true; } }
<?php // Holds the list of Friend requests sent $sent_friend_requests = $relation->getSentFriendRequests(); if (!empty($sent_friend_requests)) { echo '<table>'; foreach ($sent_friend_requests as $rel) { echo '<tr>'; $friend = $relation->getFriend($rel); echo '<td><a href="profile.php?uid=' . $friend->getUserId() . '">' . ucfirst($friend->getUsername()) . '</a></li>'; echo '<td><a href="user_action.php?action=cancel&friend_id='. $friend->getUserId() .'" title="Cancel Request">Cancel</a></td>'; echo '</tr>'; } echo '</table>'; } else { echo '<h6>No friend requests sent!</h6>'; }
<?php // Holds the list of friend requests for user $user_friend_requests = $relation->getFriendRequests(); if (!empty($user_friend_requests)) { echo '<table>'; foreach ($user_friend_requests as $rel) { echo '<tr>'; $friend = $relation->getFriend($rel); echo '<td><a href="profile.php?uid=' . $friend->getUserId() . '">' . ucfirst($friend->getUsername()) . '</a></li>'; echo '<td><a href="user_action.php?action=accept&friend_id='. $friend->getUserId() .'" title="Accept friend Request">Accept</a></td>'; echo '<td><a href="user_action.php?action=decline&friend_id='. $friend->getUserId() .'">Decline</a></td>'; echo '</tr>'; } echo '</table>'; } else { echo '<h6>No friend requests!</h6>'; }
<?php // List of user friends $user_friends = $relation->getFriendsList(); if (!empty($user_friends)) { echo '<ul>'; foreach ($user_friends as $rel) { $friend = $relation->getFriend($rel); echo '<li><a href="profile.php?uid=' . $friend->getUserId() . '">' . ucfirst($friend->getUsername()) . '</a></li>'; } echo '</ul>'; } else { echo '<h6>You don't have any friends yet!</h6>'; }
<?php include_once('app/config.php'); // Check if the page request type if ($_SERVER['REQUEST_METHOD'] === 'POST' && !empty($_POST) && isset($_POST['email']) && isset($_POST['password'])) { $email = $_POST['email']; $password = $_POST['password']; // Clean user input values $c_email = $mysqli->real_escape_string($email); $c_password = $mysqli->real_escape_string($password); $resultObj = $mysqli->query('SELECT * FROM `users` ' . ' WHERE `email` = "' . $c_email . '"' . ' AND `password` = "' . $c_password . '"'); if ($mysqli->affected_rows > 0) { $user_details = $resultObj->fetch_assoc(); setcookie('uid', $user_details['user_id'], time() + (86400 * 30), '/'); // Logged in, redirect to home. header('Location: home.php'); } else { // Not logged in, redirect to login with error. header('Location: login.php?err=invalid'); } } else if ($_SERVER['REQUEST_METHOD'] == 'GET') { header('Location: login.php'); }
<?php include_once('app/config.php'); // If they try to visit this page directly if (empty($_GET)) { header('Location: home.php'); } $user = new User(); // Check for user login if (isset($_COOKIE['uid']) && is_numeric($_COOKIE['uid']) && in_array($_COOKIE['uid'], array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10))) { $user = $user->getUser($mysqli, (int) $_COOKIE['uid']); $relation = new Relation($mysqli, $user); } else { header('Location: login.php'); } $allowed_actions = array( 'accept', // status to 1 'decline', // status to 2 'cancel', // delete relationship 'block', // status 3 'unblock', // delete relationship 'add', // insert friend request 'unfriend', // delete a friend ); $allowed_friends = array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10); if ( isset($_GET['action']) && in_array($_GET['action'], $allowed_actions) && isset($_GET['friend_id']) && in_array($_GET['friend_id'], $allowed_friends) ) { $action = $_GET['action']; $friend_id = (int) $_GET['friend_id']; $friend = new User(); $friend = $friend->getUser($mysqli, $friend_id); // Process based on the action switch ($action) { case 'accept': $result = $relation->acceptFriendRequest($friend); break; case 'decline': $result = $relation->declineFriendRequest($friend); break; case 'cancel': $result = $relation->cancelFriendRequest($friend); break; case 'block': $result = $relation->block($friend); break; case 'unblock': $result = $relation->unblockFriend($friend); break; case 'add': $result = $relation->addFriendRequest($friend); break; case 'unfriend': $result = $relation->unfriend($friend); break; } // Set the message cookie so that it shows this message in the home page. if ($result) { setcookie('status', 'success'); } else { setcookie('status', 'failed'); } // Redirect to home header('Location: home.php'); } else { header('Location: home.php'); }
<?php include_once('app/config.php'); $user = new User(); // Check if the user is logged in if (isset($_COOKIE['uid']) && is_numeric($_COOKIE['uid']) && in_array($_COOKIE['uid'], array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10))) { $user = $user->getUser($mysqli, (int) $_COOKIE['uid']); $relation = new Relation($mysqli, $user); } else { header('Location: login.php'); } $msg = ''; $status = array( 'success' => 'Operation performed Successfully.', 'failed' => 'Action Failed to process!' ); if (isset($_COOKIE['status']) && array_key_exists($_COOKIE['status'], $status)) { $msg = $status[$_COOKIE['status']]; // clear the cookie setcookie('status', ''); unset($_COOKIE['status']); } ?> <!-- Basic html tags --> <?php if ($msg !== '') echo '<p>' . $msg . '</p>'; ?> <div class="user-details"> <p>Username: <b><?php echo $user->getUsername(); ?></b></p> <p>Email: <b><?php echo $user->getEmail(); ?></b></p> <p><a href="logout.php" title="logout">Logout</a></p> <hr/> <h4>Friends</h4> <?php include_once('includes/user_friends.php'); ?> </div> <div> <h3>Friend Requests</h3> <div> <?php include_once('includes/user_friend_requests.php'); ?> </div> </div> <div> <h3>Blocked Friends</h3> <div> <?php include_once('includes/blocked_friends.php'); ?> </div> </div>
<?php include_once('app/config.php'); $user = new User(); if (isset($_COOKIE['uid']) && is_numeric($_COOKIE['uid']) && in_array($_COOKIE['uid'], array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10))) { // If there is not uid redirect to home page. if (empty($_GET) || !isset($_GET['uid'])) { header('Location: home.php'); } //################ Logged in user details ################################### // Logged in user details. $user = $user->getUser($mysqli, (int) $_COOKIE['uid']); // Relation of the logged in user $relation = new Relation($mysqli, $user); //################# Profile user details #################################### $friend_id = (int) $_GET['uid']; // Check if the profile is same as the logged in user if ($friend_id === $user->getUserId()) { $profile = $user; $profile_relation = $relation; $profile_friends = $relation->getFriendsList(); } else { // Profile use details $profile = (new User())->getUser($mysqli, $friend_id); // Relation object for the current profile being showed $profile_relation = new Relation($mysqli, $profile); // Got the Friends list $profile_friends = $profile_relation->getFriendsList(); // Get the relationship between the current user and the profile user. $relationship = $relation->getRelationship($profile); } // Checks if the profile is blocked include_once('includes/blocked_profile.php'); } else { header('Location: login.php'); } ?> <div class="container"> <?php if ($is_blocked === false) { ?> <div> <h3>Profile</h3> <div class="profile-body"> <?php echo '<p><a href="home.php" style="text-decoration:none;">Home</a></p>'; echo '<p>Username: <b>' . $profile->getUsername() . '</b></p>'; echo '<p>Email: <b>' . $profile->getEmail() . '</b></p>'; // Check if the current user is not the profile user. if ($profile->getUserId() !== $user->getUserId()) { // Check if user is there in any relationship record if ($relationship !== false) { switch ($relationship->getStatus()) { case 0: if ($relationship->getActionUserId() == $user->getUserId()) { echo '<a href="user_action.php?action=cancel&friend_id=' . $profile->getUserId() . '">Cancel Request</a>'; } else { echo '<a href="user_action.php?action=accept&friend_id=' . $profile->getUserId() . '">Accept Request</a>'; } break; case 1: echo '<a href="user_action.php?action=unfriend&friend_id=' . $profile->getUserId() . '">Unfriend</a>'; break; case 2: echo '<small>Your request has been declined!</small>'; break; } } else if ($relationship === false) { echo '<a href="user_action.php?action=add&friend_id=' . $profile->getUserId() . '">Add Friend</a>'; } } echo '<hr/>'; // Display profile friends if (!empty($profile_friends)) { echo '<ul>'; foreach ($profile_friends as $rel) { $friend = $profile_relation->getFriend($rel); echo '<li><a href="profile.php?uid=' . $friend->getUserId() . '">' . ucfirst($friend->getUsername()) . '</a></li>'; } echo '</ul>'; } else { echo '<h6>No Friends</h6>'; } ?> </div> </div> <?php } else { ?> <p>You can't view this profile. It is either blocked or inactive</p> <?php } ?> </div>


Share



Talk

tamilps2Profile

Facebook Like Chat Application in PHP

03 April 2014Reading Time:4 min



Facebooks Chat application is more social and it has a good user base. Making a simple chat application like Facebook is pretty much simple. In this post, I will show you how to make a simple chat application just like Facebook.



Facebook Like Chat Application

DOWNLOAD SOURCE

Database Design



Database Schema

There are two tables in this design,users, andchat. This schema design does not implement a real authentication system. It just simulates a situation where both the users are logged in by passing the user id through the browser address bar i.e as a parameter.

The chat table has a foreign key reference to the users table id field.

Chat Class

The Chat Class (FbChatMock) contains the core methods for adding and retrieving the chat messages from the database. This class also connects to the database when the object is first created.

The methods in this class are easy to understand. TheaddMessage()method adds the user-provided message by escaping it throughreal_escape_stringand adds the message into the database. The user id is cast into an integer so that nothing gets inserted other than an integer value.

ThegetMessagesmethod makes a JOIN statement with both the users and the chat table on the user_id field.

FbChatMock.php

/** * @author Tamil selvan k */ class FbChatMock { // Holds the database connection private $dbConnection; //----- Database connection details --/ //-- Change these to your database values private $_dbHost = 'localhost'; private $_dbUsername = 'root'; private $_dbPassword = ''; public $_databaseName = 'fbchat'; //----- ----/ /** * Create's the connection to the database and stores it in the dbConnection */ public function __construct() { $this->dbConnection = new mysqli($this->_dbHost, $this->_dbUsername, $this->_dbPassword, $this->_databaseName); if ($this->dbConnection->connect_error) { die('Connection error.'); } } /** * Get the list of messages from the chat * * @return array */ public function getMessages() { $messages = array(); $query = " SELECT `chat`.`message`, `chat`.`sent_on`, `users`.`id`, `users`.`username` FROM `users` JOIN `chat` ON `chat`.`user_id` = `users`.`id` ORDER BY `sent_on`"; // Execute the query $resultObj = $this->dbConnection->query($query); // Fetch all the rows at once. while ($row = $resultObj->fetch_assoc()) { $messages[] = $row; } return $messages; } /** * Add a new message to the chat table * * @param Integer $userId The user who sent the message * @param String $message The Actual message * @return bool|Integer The last inserted id of success and false on faileur */ public function addMessage($userId, $message) { $addResult = false; $cUserId = (int) $userId; // Escape the message with mysqli real escape $cMessage = $this->dbConnection->real_escape_string($message); $query = " INSERT INTO `chat`(`user_id`, `message`, `sent_on`) VALUES ({$cUserId}, '{$cMessage}', UNIX_TIMESTAMP())"; $result = $this->dbConnection->query($query); if ($result !== false) { // Get the last inserted row id. $addResult = $this->dbConnection->insert_id; } else { echo $this->dbConnection->error; } return $addResult; } }
<?php @session_start(); $_SESSION['user_id'] = isset($_GET['user_id']) ? (int) $_GET['user_id'] : 0; if ($_SESSION['user_id'] === 0) { echo '<h1> Provide your user id</h1> '; exit; } // Load the messages initially require_once __DIR__ . '/../FbChatMock.php'; $chat = new FbChatMock(); $messages = $chat->getMessages(); ?> <div class="container" style="border: 1px solid lightgray;"> <div class="msg-wgt-header"> <a href="#">John</a> </div> <div class="msg-wgt-body"> <table> <?php if (!empty($messages)) { foreach ($messages as $message) { $msg = htmlentities($message['message'], ENT_NOQUOTES); $user_name = ucfirst($message['username']); $sent = date('F j, Y, g:i a', $message['sent_on']); echo <<<MSG <tr class="msg-row-container"> <td> <div class="msg-row"> <div class="avatar"></div> <div class="message"> <span class="user-label"><a href="#" style="color: #6D84B4;">{$user_name}</a> <span class="msg-time">{$sent}</span></span><br/>{$msg} </div> </div> </td> </tr> MSG; } } else { echo '<span style="margin-left: 25px;">No chat messages available!</span>'; } ?> </table> </div> <div class="msg-wgt-footer"> <textarea id="chatMsg" placeholder="Type your message. Press Shift + Enter for newline"></textarea> </div> </div>
session_start(); if (isset($_POST['msg'])) { require_once __DIR__ . '/../../core/FbChatMock.php'; $userId = (int) $_SESSION['user_id']; // Escape the message string $msg = htmlentities($_POST['msg'], ENT_NOQUOTES); $chat = new FbChatMock(); $result = $chat->addMessage($userId, $msg); }
require_once __DIR__ . '/../../core/FbChatMock.php'; $chat = new FbChatMock(); $messages = $chat->getMessages(); $chat_converstaion = array(); if (!empty($messages)) { $chat_converstaion[] = '<table>'; foreach ($messages as $message) { $msg = htmlentities($message['message'], ENT_NOQUOTES); $user_name = ucfirst($message['username']); $sent = date('F j, Y, g:i a', $message['sent_on']); $chat_converstaion[] = <<<MSG <tr class="msg-row-container"> <td> <div class="msg-row"> <div class="avatar"></div> <div class="message"> <span class="user-label"><a href="#" style="color: #6D84B4;">{$user_name}</a> <span class="msg-time">{$sent}</span></span><br/>{$msg} </div> </div> </td> </tr> MSG; } $chat_converstaion[] = '</table>'; } else { echo '<span style="margin-left: 25px;">No chat messages available!</span>'; } echo implode('', $chat_converstaion);
/** * Add a new chat message * * @param {string} message */ function send_message(message) { $.ajax({ url: '/ajax/add_msg.php', method: 'post', data: {msg: message}, success: function(data) { $('#chatMsg').val(''); get_messages(); } }); } /** * Get's the chat messages. */ function get_messages() { $.ajax({ url: '/ajax/get_messages.php', method: 'GET', success: function(data) { $('.msg-wgt-body').html(data); } }); } /** * Initializes the chat application */ function boot_chat() { var chatArea = $('#chatMsg'); // Load the messages every 5 seconds setInterval(get_messages, 20000);s // Bind the keyboard event chatArea.bind('keydown', function(event) { // Check if enter is pressed without pressing the shiftKey if (event.keyCode === 13 && event.shiftKey === false) { var message = chatArea.val(); // Check if the message is not empty if (message.length !== 0) { send_message(message); event.preventDefault(); } else { alert('Provide a message to send!'); chatArea.val(''); } } }); } // Initialize the chat boot_chat();
/* message box header styles*/ .msg-wgt-header { background-color: #6D84B4; border: 1px solid rgba(0, 39, 121, 0.76); color: white; text-align: center; height: 28px; } .msg-wgt-header a { text-decoration: none; font-weight: bold; color: white; vertical-align: middle; } /* message box body styles*/ .msg-wgt-body { height: 300px; overflow-y: scroll; } .msg-wgt-body table { width: 100%; } .msg-row-container { border-bottom: 1px solid lightgray; } .msg-row-container td class="" { border-bottom: 1px solid lightgray; padding: 3px 0 3px 2px; } .msg-row { width: 100%; } .message { margin-left: 40px; } /* Message box footer styles*/ .msg-wgt-footer { height: 50px; } .msg-wgt-footer textarea { width: 95%; font-family: 'tahoma'; font-size: 13px; padding: 5px; } .user-label { font-size: 11px; } .msg-time { font-size: 10px; float: right; color: gray; } .avatar { width: 24px; height: 24px; float: left; background: url('/assets/chat_avatar.jpg'); border: 1px solid lightgray; }


<?php /** * Stores the details of a particular user * * C**, */ class User { /** * The Unique id of the user * * @var Int */ private $userId; /** * Name of the user * * @var String */ private $userName; /** * User email id * * @var String */ private $email; /** * User password * * @var String */ private $password; //##################### Accessor and Mutator Methods ######################### public function getUserId() { return $this->userId; } public function setUserId($userId) { $this->userId = $userId; } public function getUsername() { return $this->userName; } public function setUsername($userName) { $this->userName = $userName; } public function getEmail() { return $this->email; } public function setEmail($email) { $this->email = $email; } public function getPassword() { return $this->password; } public function setPassword($password) { $this->password = $password; } //##################### End of Accessor and Mutator Methods ################## /** * Returns the User Object provided the id of the user. * * @param mysqli $db * @param int $id * @return User */ public function getUser($db, $id) { $resultObj = $db->query('SELECT * FROM `users` ' . 'WHERE `users`.`user_id` = ' . (int) $id); $user_details = $resultObj->fetch_assoc(); $user = new User(); $user->arrToUser($user_details); return $user; } /** * Set's the user details returned from the query into the current object. * * @param array $userRow */ public function arrToUser($userRow) { if (!empty($userRow)) { isset($userRow['user_id']) ? $this->setUserId($userRow['user_id']) : ''; isset($userRow['username']) ? $this->setUsername($userRow['username']) : ''; isset($userRow['email']) ? $this->setEmail($userRow['email']) : ''; isset($userRow['password']) ? $this->setPassword($userRow['password']) : ''; } } }


Share



Talk

tamilps2Profile

Social Network Friends Relationship System Using PHP and MySQL - Part 1

26 March 2015Reading Time:7 min



When building a social network, it is important to think about the relationship design between the users on the site. I have already posted an article on how to design a database to store such information. The article focused only on the database design aspect and how to implement it. Here we will be creating a Facebook-style friend relationship system design using PHP and MySQL entirely.

Read the post onDesigning Database for Social Network Friends Relationshipif you have not read it previously. It is a prerequisite to know some basic OOP programming in PHP or any other language.



Download SourceLive Demo



Database Design

The following is the database design for implementing the above system.



Database Schema

The important thing to understand in this design is that the id ofuser onemust always belesserthanuser two. Theaction user idmust be the id of the user who performed an action that caused thestatusto be changed.

Components

The 3 main component for implementing this system is,

User Stores a user detailsRelationship Stores details about the relationship between two users.Relation Manages the relationship operations



UML Class Diagram

Both theUserandRelationshipclasses are aData transfer object (DTO). It uses the DTO design pattern which is mostly a data carrier between the process. It mostly containsaccessorandmutatormethods along with some helper methods.

User.php

<?php /** * Stores the details of a particular user * * Copyright (c) 2013-2015 Codedodle.com * * @author Tamil Selvan K <info@codedodle.com> */ class User { /** * The Unique id of the user * * @var Int */ private $userId; /** * Name of the user * * @var String */ private $userName; /** * User email id * * @var String */ private $email; /** * User password * * @var String */ private $password; //##################### Accessor and Mutator Methods ######################### public function getUserId() { return $this->userId; } public function setUserId($userId) { $this->userId = $userId; } public function getUsername() { return $this->userName; } public function setUsername($userName) { $this->userName = $userName; } public function getEmail() { return $this->email; } public function setEmail($email) { $this->email = $email; } public function getPassword() { return $this->password; } public function setPassword($password) { $this->password = $password; } //##################### End of Accessor and Mutator Methods ################## /** * Returns the User Object provided the id of the user. * * @param mysqli $db * @param int $id * @return User */ public function getUser($db, $id) { $resultObj = $db->query('SELECT * FROM `users` ' . 'WHERE `users`.`user_id` = ' . (int) $id); $user_details = $resultObj->fetch_assoc(); $user = new User(); $user->arrToUser($user_details); return $user; } /** * Set's the user details returned from the query into the current object. * * @param array $userRow */ public function arrToUser($userRow) { if (!empty($userRow)) { isset($userRow['user_id']) ? $this->setUserId($userRow['user_id']) : ''; isset($userRow['username']) ? $this->setUsername($userRow['username']) : ''; isset($userRow['email']) ? $this->setEmail($userRow['email']) : ''; isset($userRow['password']) ? $this->setPassword($userRow['password']) : ''; } } }



<?php /** * This class is store the details of a relationship between two user objects * * ,* * , */ class Relationship { /** * User one in the relationship * * @var User */ public $userOne; /** * User two in the relationship * * @var User */ public $userTwo; /** * Determines the status of the relationship * * 0 - Pending * 1 - Accepted * 2 - Declined * 3 - Blocked * * By default the status is set to 0 */ public $status = 0; /** * This is the user who made the most recent status field update */ public $actionUserId; //##################### Accessor and Mutator Methods ######################### public function getUserOne() { return $this->userOne; } public function setUserOne(User $userOne) { $this->userOne = $userOne; } public function getUserTwo() { return $this->userTwo; } public function setUserTwo(User $userTwo) { $this->userTwo = $userTwo; } public function getStatus() { return $this->status; } public function setStatus($status) { $this->status = $status; } public function getActionUserId() { return $this->actionUserId; } public function setActionUserId($actionUserId) { $this->actionUserId = $actionUserId; } //##################### End of Accessor and Mutator Methods ################## /** * Set's the details of the relationship from the query result into the * current relationship object instance. * * @param array $row * @param mysqli $dbCon */ public function arrToRelationship($row, $dbCon) { if (!empty($row)) { if (isset($row['user_one_id']) && isset($row['user_two_id'])) { // Fetch the user details and create the user object set. $resultObj = $dbCon->query('SELECT * FROM `users` WHERE `users`.`user_id` IN (' . (int)$row['user_one_id'] . ', ' . (int)$row['user_two_id'] . ')'); $usersArr = array(); while($record = $resultObj->fetch_assoc()) { $usersArr[] = $record; } $userOne = new User(); $userTwo = new User(); // Check which user id is lesser. if ($row['user_one_id'] < $row['user_two_id']) { $userOne->arrToUser($usersArr[0]); $userTwo->arrToUser($usersArr[1]); } else { $userOne->arrToUser($usersArr[1]); $userTwo->arrToUser($usersArr[0]); } $this->setUserOne($userOne); $this->setUserTwo($userTwo); } isset($row['status']) ? $this->setStatus((int)$row['status']) : ''; isset($row['action_user_id']) ? $this->setActionUserId((int)$row['action_user_id']) : ''; } } }

ttern.

<?php /** * This class manages all the User/Friends Relationship operations. * *, * * */ class Relation { /** * The user who is currently logged in * * @var User */ private $loggedInUser; /** * Database connection * * @var mysqli */ private $dbCon; /** * @param mysqli $dbCon * @param User $loggedInUser * @return boolean|Relation */ public function __construct($dbCon, User $loggedInUser) { if ($dbCon == 'undefined') { return false; // or you could throw an exception } // Current loggedin user $this->loggedInUser = $loggedInUser; // Database Connection $this->dbCon = $dbCon; } /** * Return the friend of the current logged in user in the relationship object * * @param Relationship $rel * @return User $friend */ public function getFriend(Relationship $rel) { if ($rel->getUserOne()->getUserId() === $this->loggedInUser->getUserId()) { $friend = $rel->getUserTwo(); } else { $friend = $rel->getUserOne(); } return $friend; } /** * Get all the friends list for the currently loggedin user * * @return array Relationship Objects */ public function getFriendsList() { $id = (int)$this->loggedInUser->getUserId(); $sql = 'SELECT * FROM `relationship` WHERE ' . '(`user_one_id` = ' . $id . ' OR `user_two_id` = '. $id .') ' . 'AND `status` = 1'; $resultObj = $this->dbCon->query($sql); $rels = array(); while($row = $resultObj->fetch_assoc()) { $rel = new Relationship(); $rel->arrToRelationship($row, $this->dbCon); $rels[] = $rel; } return $rels; } /** * Get the list of friend requests sent by the logged in user * * @return array Relationship Objects */ public function getSentFriendRequests() { $id = (int) $this->loggedInUser->getUserId(); $sql = 'SELECT * FROM `relationship` WHERE ' . '(`user_one_id` = ' . $id . ' OR `user_two_id` = ' . $id . ') ' . 'AND `status` = 0 '. 'AND `action_user_id` = ' . $id; $resultObj = $this->dbCon->query($sql); $rels = array(); while($row = $resultObj->fetch_assoc()) { $rel = new Relationship(); $rel->arrToRelationship($row, $this->dbCon); $rels[] = $rel; } return $rels; } /** * Get the list of friend requests for the logged in user * * @return array Relationship Objects */ public function getFriendRequests() { $id = (int) $this->loggedInUser->getUserId(); $sql = 'SELECT * FROM `relationship` ' . 'WHERE (`user_one_id` = ' . $id . ' OR `user_two_id` = '. $id .')' . ' AND `status` = 0 ' . 'AND `action_user_id` != ' . $id; $resultObj = $this->dbCon->query($sql); $rels = array(); while($row = $resultObj->fetch_assoc()) { $rel = new Relationship(); $rel->arrToRelationship($row, $this->dbCon); $rels[] = $rel; } return $rels; } /** * Get the list of friends blocked by the current user. * * @return Relationship array */ public function getBlockedFriends() { $id = (int) $this->loggedInUser->getUserId(); $sql = 'SELECT * FROM `relationship` ' . 'WHERE (`user_one_id` = ' . $id . ' OR `user_two_id` = '. $id .')' . ' AND `status` = 3 ' . 'AND `action_user_id` = ' . $id; $resultObj = $this->dbCon->query($sql); $rels = array(); while($row = $resultObj->fetch_assoc()) { $rel = new Relationship(); $rel->arrToRelationship($row, $this->dbCon); $rels[] = $rel; } return $rels; } /** * Get the relatiohship for the friend and user * * @param User $user * @return boolean|int - either false or the relationship status */ public function getRelationship(User $user) { $user_one = (int) $this->loggedInUser->getUserId(); $user_two = (int) $user->getUserId(); if ($user_one > $user_two) { $temp = $user_one; $user_one = $user_two; $user_two = $temp; } $sql = 'SELECT * FROM `relationship` ' . 'WHERE `user_one_id` = ' . $user_one . ' AND `user_two_id` = ' . $user_two; $resultObj = $this->dbCon->query($sql); if ($this->dbCon->affected_rows > 0) { $row = $resultObj->fetch_assoc(); $relationship = new Relationship(); $relationship->arrToRelationship($row, $this->dbCon); return $relationship; } return false; } /** * Insert a new friends request * * @param User $user - User to which the friend request must be added with. * @return Boolean */ public function addFriendRequest(User $user) { $user_one = (int) $this->loggedInUser->getUserId(); $action_user_id = $user_one; $user_two = (int) $user->getUserId(); if ($user_one > $user_two) { $temp = $user_one; $user_one = $user_two; $user_two = $temp; } $sql = 'INSERT INTO `relationship` ' . '(`user_one_id`, `user_two_id`, `status`, `action_user_id`) ' . 'VALUES ' . '(' . $user_one . ', '. $user_two .', 0, '. $action_user_id .')'; $this->dbCon->query($sql); if ($this->dbCon->affected_rows > 0) { return true; } return false; } /** * Accept a friend request * * @param User $user - User to whome the friend request must be accepted with. * @return Boolean */ public function acceptFriendRequest(User $user) { $user_one = (int) $this->loggedInUser->getUserId(); $action_user_id = $user_one; $user_two = $user->getUserId(); if ($user_one > $user_two) { $temp = $user_one; $user_one = $user_two; $user_two = $temp; } $sql = 'UPDATE `relationship` ' . 'SET `status` = 1, `action_user_id` = '. $action_user_id .' WHERE `user_one_id` = '. $user_one .' AND `user_two_id` = ' . $user_two; $this->dbCon->query($sql); if ($this->dbCon->affected_rows > 0) { return true; } return false; } /** * Decline a friend request for the user * * @params User $user - The user whose request to be declined * @return Boolean */ public function declineFriendRequest(User $user) { $user_one = (int) $this->loggedInUser->getUserId(); $action_user_id = $user_one; $user_two = $user->getUserId(); if ($user_one > $user_two) { $temp = $user_one; $user_one = $user_two; $user_two = $temp; } $sql = 'UPDATE `relationship` ' . 'SET `status` = 2, `action_user_id` = '. $action_user_id .' WHERE `user_one_id` = '. $user_one .' AND `user_two_id` = ' . $user_two; $this->dbCon->query($sql); if ($this->dbCon->affected_rows > 0) { return true; } return false; } /** * Cancel a friend request * * @param User $user - The friend details * @return Boolean */ public function cancelFriendRequest(User $user) { $user_one = (int) $this->loggedInUser->getUserId(); $user_two = (int) $user->getUserId(); if ($user_one > $user_two) { $temp = $user_one; $user_one = $user_two; $user_two = $temp; } $sql = 'DELETE FROM `relationship` ' . 'WHERE `user_one_id` = ' . $user_one . ' AND `user_two_id` = ' . $user_two . ' AND `status` = 0'; $this->dbCon->query($sql); if ($this->dbCon->affected_rows > 0) { return true; } return false; } /** * Remove a friend from the friends list * * @param User $user - The friend details * @return Boolean */ public function unfriend(User $user) { $user_one = (int) $this->loggedInUser->getUserId(); $user_two = (int) $user->getUserId(); if ($user_one > $user_two) { $temp = $user_one; $user_one = $user_two; $user_two = $temp; } $sql = 'DELETE FROM `relationship` ' . 'WHERE `user_one_id` = ' . $user_one . ' AND `user_two_id` = ' . $user_two . ' AND `status` = 1'; $this->dbCon->query($sql); if ($this->dbCon->affected_rows > 0) { return true; } return false; } /** * Block a particular user * * @param User $user - The user to be blocked * @return Boolean */ public function block(User $user) { $user_one = (int) $this->loggedInUser->getUserId(); $action_user_id = $user_one; $user_two = $user->getUserId(); if ($user_one > $user_two) { $temp = $user_one; $user_one = $user_two; $user_two = $temp; } $sql = 'UPDATE `relationship` ' . 'SET `status` = 3, `action_user_id` = '. $action_user_id .' WHERE `user_one_id` = '. $user_one .' AND `user_two_id` = ' . $user_two; $this->dbCon->query($sql); if ($this->dbCon->affected_rows > 0) { return true; } return false; } /** * Unblock a friend who is blocked already. * * @param User $user * @return boolean */ public function unblockFriend(User $user) { $user_one = (int) $this->loggedInUser->getUserId(); $user_two = (int) $user->getUserId(); if ($user_one > $user_two) { $temp = $user_one; $user_one = $user_two; $user_two = $temp; } $sql = 'DELETE FROM `relationship` ' . 'WHERE `user_one_id` = ' . $user_one . ' AND `user_two_id` = ' . $user_two . ' AND `status` = 3'; $this->dbCon->query($sql); if ($this->dbCon->affected_rows > 0) { return true; } return false; } }
function _(x){ 	return document.getElementById(x); } function toggleElement(x){ 	var x = _(x); 	if(x.style.display == 'block'){ 		x.style.display = 'none'; 	}else{ 		x.style.display = 'block'; 	} }
<?php function img_resize($target, $newcopy, $w, $h, $ext) { list($w_orig, $h_orig) = getimagesize($target); $scale_ratio = $w_orig / $h_orig; if (($w / $h) > $scale_ratio) { $w = $h * $scale_ratio; } else { $h = $w / $scale_ratio; } $img = ""; $ext = strtolower($ext); if ($ext == "gif"){ $img = imagecreatefromgif($target); } else if($ext =="png"){ $img = imagecreatefrompng($target); } else { $img = imagecreatefromjpeg($target); } $tci = imagecreatetruecolor($w, $h); // imagecopyresampled(dst_img, src_img, dst_x, dst_y, src_x, src_y, dst_w, dst_h, src_w, src_h)
imagecopyresampled($tci, $img, 0, 0, 0, 0, $w, $h, $w_orig, $h_orig); imagejpeg($tci, $newcopy, 84); } 
?>
<?php include_once("../php_includes/check_login_status.php"); if($user_ok != true || $log_username == "") { 	exit(); } ?><?php if (isset($_FILES["avatar"]["name"]) && $_FILES["avatar"]["tmp_name"] != ""){ 	$fileName = $_FILES["avatar"]["name"]; $fileTmpLoc = $_FILES["avatar"]["tmp_name"]; 	$fileType = $_FILES["avatar"]["type"]; 	$fileSize = $_FILES["avatar"]["size"]; 	$fileErrorMsg = $_FILES["avatar"]["error"]; 	$kaboom = explode(".", $fileName); 	$fileExt = end($kaboom); 	list($width, $height) = getimagesize($fileTmpLoc); 	if($width < 10 || $height < 10){ 		header("location: ../message.php?msg=ERROR: That image has no dimensions"); exit();	 	} 	$db_file_name = rand(100000000000,999999999999).".".$fileExt; 	if($fileSize > 1048576) { 		header("location: ../message.php?msg=ERROR: Your image file was larger than 1mb"); 		exit();	 	} else if (!preg_match("/\.(gif|jpg|png)$/i", $fileName) ) { 		header("location: ../message.php?msg=ERROR: Your image file was not jpg, gif or png type"); 		exit(); 	} else if ($fileErrorMsg == 1) { 		header("location: ../message.php?msg=ERROR: An unknown error occurred"); 		exit(); 	} 	$sql = "SELECT avatar FROM users WHERE username='$log_username' LIMIT 1"; 	$query = mysqli_query($db_conx, $sql); 	$row = mysqli_fetch_row($query); 	$avatar = $row[0]; 	if($avatar != ""){ 		$picurl = "../user/$log_username/$avatar"; 	 if (file_exists($picurl)) { unlink($picurl); } 	} 	$moveResult = move_uploaded_file($fileTmpLoc, "../user/$log_username/$db_file_name"); 	if ($moveResult != true) { 		header("location: ../message.php?msg=ERROR: File upload failed"); 		exit(); 	} 	include_once("../php_includes/image_resize.php"); 	$target_file = "../user/$log_username/$db_file_name"; 	$resized_file = "../user/$log_username/$db_file_name"; 	$wmax = 200; 	$hmax = 300; 	img_resize($target_file, $resized_file, $wmax, $hmax, $fileExt); 	$sql = "UPDATE users SET avatar='$db_file_name' WHERE username='$log_username' LIMIT 1"; 	$query = mysqli_query($db_conx, $sql); 	mysqli_close($db_conx); 	header("location: ../user.php?u=$log_username"); 	exit(); } 
?>
<?php include_once("php_includes/check_login_status.php"); // Initialize any variables that the page might echo
$u = ""; $sex = "Male"; $userlevel = ""; $profile_pic = ""; $profile_pic_btn = ""; $avatar_form = ""; $country = ""; $joindate = ""; $lastsession = ""; // Make sure the _GET username is set, and sanitize it
if(isset($_GET["u"])){ 	$u = preg_replace('#[^a-z0-9]#i', '', $_GET['u']); } else { header("location: http://www.webintersect.com"); exit();	 } // Select the member from the users table
$sql = "SELECT * FROM users WHERE username='$u' AND activated='1' LIMIT 1"; $user_query = mysqli_query($db_conx, $sql); // Now make sure that user exists in the table
$numrows = mysqli_num_rows($user_query); if($numrows < 1){ 	echo "That user does not exist or is not yet activated, press back"; exit();	 } // Check to see if the viewer is the account owner
$isOwner = "no"; if($u == $log_username && $user_ok == true){ 	$isOwner = "yes"; 	$profile_pic_btn = '<a href="#" onclick="return false;" onmousedown="toggleElement(\'avatar_form\')">Toggle Avatar Form</a>'; 	$avatar_form = '<form id="avatar_form" enctype="multipart/form-data" method="post" action="php_parsers/photo_system.php">'; 	$avatar_form .= '<h4>Change your avatar</h4>'; 	$avatar_form .= '<input type="file" name="avatar" required>'; 	$avatar_form .= '<p><input type="submit" value="Upload"></p>'; 	$avatar_form .= '</form>'; } // Fetch the user row from the query above
while ($row = mysqli_fetch_array($user_query, MYSQLI_ASSOC)) { 	$profile_id = $row["id"]; 	$gender = $row["gender"]; 	$country = $row["country"]; 	$userlevel = $row["userlevel"]; 	$avatar = $row["avatar"]; 	$signup = $row["signup"]; 	$lastlogin = $row["lastlogin"]; 	$joindate = strftime("%b %d, %Y", strtotime($signup)); 	$lastsession = strftime("%b %d, %Y", strtotime($lastlogin)); } if($gender == "f"){ 	$sex = "Female"; } $profile_pic = '<img src="user/'.$u.'/'.$avatar.'" alt="'.$u.'">'; if($avatar == NULL){ 	$profile_pic = '<img src="images/avatardefault.jpg" alt="'.$user1.'">'; } ?><?php $isFriend = false; $ownerBlockViewer = false; $viewerBlockOwner = false; if($u != $log_username && $user_ok == true){ 	$friend_check = "SELECT id FROM friends WHERE user1='$log_username' AND user2='$u' AND accepted='1' OR user1='$u' AND user2='$log_username' AND accepted='1' LIMIT 1"; 	if(mysqli_num_rows(mysqli_query($db_conx, $friend_check)) > 0){ $isFriend = true; } 	$block_check1 = "SELECT id FROM blockedusers WHERE blocker='$u' AND blockee='$log_username' LIMIT 1"; 	if(mysqli_num_rows(mysqli_query($db_conx, $block_check1)) > 0){ $ownerBlockViewer = true; } 	$block_check2 = "SELECT id FROM blockedusers WHERE blocker='$log_username' AND blockee='$u' LIMIT 1"; 	if(mysqli_num_rows(mysqli_query($db_conx, $block_check2)) > 0){ $viewerBlockOwner = true; } } ?><?php $friend_button = '<button disabled>Request As Friend</button>'; $block_button = '<button disabled>Block User</button>'; // LOGIC FOR FRIEND BUTTON
if($isFriend == true){ 	$friend_button = '<button onclick="friendToggle(\'unfriend\',\''.$u.'\',\'friendBtn\')">Unfriend</button>'; } else if($user_ok == true && $u != $log_username && $ownerBlockViewer == false){ 	$friend_button = '<button onclick="friendToggle(\'friend\',\''.$u.'\',\'friendBtn\')">Request As Friend</button>'; } // LOGIC FOR BLOCK BUTTON
if($viewerBlockOwner == true){ 	$block_button = '<button onclick="blockToggle(\'unblock\',\''.$u.'\',\'blockBtn\')">Unblock User</button>'; } else if($user_ok == true && $u != $log_username){ 	$block_button = '<button onclick="blockToggle(\'block\',\''.$u.'\',\'blockBtn\')">Block User</button>'; } ?><?php $friendsHTML = ''; $friends_view_all_link = ''; $sql = "SELECT COUNT(id) FROM friends WHERE user1='$u' AND accepted='1' OR user2='$u' AND accepted='1'"; $query = mysqli_query($db_conx, $sql); $query_count = mysqli_fetch_row($query); $friend_count = $query_count[0]; if($friend_count < 1){ 	$friendsHTML = $u." has no friends yet"; } else { 	$max = 18; 	$all_friends = array(); 	$sql = "SELECT user1 FROM friends WHERE user2='$u' AND accepted='1' ORDER BY RAND() LIMIT $max"; 	$query = mysqli_query($db_conx, $sql); 	while ($row = mysqli_fetch_array($query, MYSQLI_ASSOC)) { 		array_push($all_friends, $row["user1"]); 	} 	$sql = "SELECT user2 FROM friends WHERE user1='$u' AND accepted='1' ORDER BY RAND() LIMIT $max"; 	$query = mysqli_query($db_conx, $sql); 	while ($row = mysqli_fetch_array($query, MYSQLI_ASSOC)) { 		array_push($all_friends, $row["user2"]); 	} 	$friendArrayCount = count($all_friends); 	if($friendArrayCount > $max){ 		array_splice($all_friends, $max); 	} 	if($friend_count > $max){ 		$friends_view_all_link = '<a href="view_friends.php?u='.$u.'">view all</a>'; 	} 	$orLogic = ''; 	foreach($all_friends as $key => $user){ 			$orLogic .= "username='$user' OR "; 	} 	$orLogic = chop($orLogic, "OR "); 	$sql = "SELECT username, avatar FROM users WHERE $orLogic"; 	$query = mysqli_query($db_conx, $sql); 	while($row = mysqli_fetch_array($query, MYSQLI_ASSOC)) { 		$friend_username = $row["username"]; 		$friend_avatar = $row["avatar"]; 		if($friend_avatar != ""){ 			$friend_pic = 'user/'.$friend_username.'/'.$friend_avatar.''; 		} else { 			$friend_pic = 'images/avatardefault.jpg'; 		} 		$friendsHTML .= '<a href="user.php?u='.$friend_username.'"><img class="friendpics" src="'.$friend_pic.'" alt="'.$friend_username.'" title="'.$friend_username.'"></a>'; 	} } ?> <!DOCTYPE html> <html> <head> <meta charset="UTF-8"> <title><?php echo $u; ?></title> <link rel="icon" href="favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="style/style.css"> <style type="text/css"> div#profile_pic_box{float:right; border:#999 2px solid; width:200px; height:200px; margin:20px 30px 0px 0px; overflow-y:hidden;} div#profile_pic_box > img{z-index:2000; width:200px;} div#profile_pic_box > a { 	display: none; 	position:absolute; 	margin:140px 0px 0px 120px; 	z-index:4000; 	background:#D8F08E; 	border:#81A332 1px solid; 	border-radius:3px; 	padding:5px; 	font-size:12px; 	text-decoration:none; 	color:#60750B; } div#profile_pic_box > form{ 	display:none; 	position:absolute; 	z-index:3000; 	padding:10px; 	opacity:.8; 	background:#F0FEC2; 	width:180px; 	height:180px; } div#profile_pic_box:hover a { display: block; } img.friendpics{border:#000 1px solid; width:40px; height:40px; margin:2px;} </style> <script src="js/main.js"></script> <script src="js/ajax.js"></script> <script type="text/javascript"> function friendToggle(type,user,elem){ 	var conf = confirm("Press OK to confirm the '"+type+"' action for user <?php echo $u; ?>."); 	if(conf != true){ 		return false; 	} 	_(elem).innerHTML = 'please wait ...'; 	var ajax = ajaxObj("POST", "php_parsers/friend_system.php"); 	ajax.onreadystatechange = function() { 		if(ajaxReturn(ajax) == true) { 			if(ajax.responseText == "friend_request_sent"){ 				_(elem).innerHTML = 'OK Friend Request Sent'; 			} else if(ajax.responseText == "unfriend_ok"){ 				_(elem).innerHTML = '<button onclick="friendToggle(\'friend\',\'<?php echo $u; ?>\',\'friendBtn\')">Request As Friend</button>'; 			} else { 				alert(ajax.responseText); 				_(elem).innerHTML = 'Try again later'; 			} 		} 	} 	ajax.send("type="+type+"&user="+user); } function blockToggle(type,blockee,elem){ 	var conf = confirm("Press OK to confirm the '"+type+"' action on user <?php echo $u; ?>."); 	if(conf != true){ 		return false; 	} 	var elem = document.getElementById(elem); 	elem.innerHTML = 'please wait ...'; 	var ajax = ajaxObj("POST", "php_parsers/block_system.php"); 	ajax.onreadystatechange = function() { 		if(ajaxReturn(ajax) == true) { 			if(ajax.responseText == "blocked_ok"){ 				elem.innerHTML = '<button onclick="blockToggle(\'unblock\',\'<?php echo $u; ?>\',\'blockBtn\')">Unblock User</button>'; 			} else if(ajax.responseText == "unblocked_ok"){ 				elem.innerHTML = '<button onclick="blockToggle(\'block\',\'<?php echo $u; ?>\',\'blockBtn\')">Block User</button>'; 			} else { 				alert(ajax.responseText); 				elem.innerHTML = 'Try again later'; 			} 		} 	} 	ajax.send("type="+type+"&blockee="+blockee); } </script> </head> <body> <?php include_once("template_pageTop.php"); ?> <div id="pageMiddle"> <div id="profile_pic_box"><?php echo $profile_pic_btn; ?><?php echo $avatar_form; ?><?php echo $profile_pic; ?></div> <h2><?php echo $u; ?></h2> <p>Is the viewer the page owner, logged in and verified? <b><?php echo $isOwner; ?></b></p> <p>Gender: <?php echo $sex; ?></p> <p>Country: <?php echo $country; ?></p> <p>User Level: <?php echo $userlevel; ?></p> <p>Join Date: <?php echo $joindate; ?></p> <p>Last Session: <?php echo $lastsession; ?></p> <hr /> <p>Friend Button: <span id="friendBtn"><?php echo $friend_button; ?></span> <?php echo $u." has ".$friend_count." friends"; ?> <?php echo $friends_view_all_link; ?></p> <p>Block Button: <span id="blockBtn"><?php echo $block_button; ?></span></p> <hr /> <p><?php echo $friendsHTML; ?></p> </div> <?php include_once("template_pageBottom.php"); 
?> 
</body> 
</html>
<!DOCTYPE html> <html> <head> <meta charset="UTF-8"> <title>friendzzonemeet </title> <link rel="icon" href="favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="style/style.css"> </head> <body> <?php include_once("template_pageTop.php"); ?> <div id="pageMiddle"> &nbsp; </div> <?php include_once("template_pageBottom.php"); 
?> 
</body> 
</html>
body { margin: 0px; font-family: Tahoma, Geneva, sans-serif; font-size: 14px; } /* PAGE TOP */ #pageTop { 	background:url(headerSliver.png) repeat-x; 	height: 90px; } #pageTop > #pageTopWrap { 	width: 1000px; 	margin: 0px auto; 	height: 90px; } #pageTop > #pageTopWrap > #pageTopLogo { 	float: left; 	height: 90px; 	width: 108px; } #pageTop > #pageTopWrap > #pageTopRest { 	float: left; 	height: 90px; 	width: 892px; } #pageTop > #pageTopWrap > #pageTopRest > #menu1 { 	height: 44px; } #pageTop > #pageTopWrap > #pageTopRest > #menu1 > div { 	margin-top: 8px; 	padding: 4px; 	text-align:right; } #pageTop > #pageTopWrap > #pageTopRest > #menu1 > div > a { 	color: #CCC; 	text-decoration: none; } #pageTop > #pageTopWrap > #pageTopRest > #menu1 > div > a:hover { 	color: #C0E73D; } #pageTop > #pageTopWrap > #pageTopRest > #menu2 { 	height: 44px; } #pageTop > #pageTopWrap > #pageTopRest > #menu2 > div { 	margin-top: 2px; 	padding: 4px; } #pageTop > #pageTopWrap > #pageTopRest > #menu2 > div > a { 	display: block; 	float: left; 	color:#CCC; 	text-decoration: none; 	margin: 0px 16px; } #pageTop > #pageTopWrap > #pageTopRest > #menu2 > div > a:hover { 	color: #C0E73D; } /* PAGE MIDDLE */ #pageMiddle{ 	width: 1000px; 	margin: 0px auto; 	height: 900px; } /* PAGE BOTTOM */ #pageBottom{ 	background: #666; 	padding: 24px; 	font-size: 12px; 	color: #CCC; 	text-align: center; }
<div id="pageTop"> <div id="pageTopWrap"> <div id="pageTopLogo"> <a href="http://www.webintersect.com"> <img src="images/logo.png" alt="logo" title="Web Intersect 2.0"> </a> </div> <div id="pageTopRest"> <div id="menu1"> <div> <a href="#">Sign Up / Log In</a> </div> </div> <div id="menu2"> <div> <a href="http://www.webintersect.com"> <img src="images/home.png" alt="home" title="Home"> </a> <a href="#">Menu_Item_1</a> <a href="#">Menu_Item_2</a> 
</div>
 </div> 
 </div> 
 </div> 
 </div>
<div id="pageBottom">& copy rights </div>

# 1 ---- Establish a custom 404 File not Found page ---- ErrorDocument 404 /filenotfound.php # 2 ---- Prevent directory file listing in all of your folders ---- IndexIgnore *
// Make this function external like I did in the video
function _(x){ 	return document.getElementById(x); } // And all over the site from now on you can get html elements by their id by simply using
_("div1").innerHTML = "Hello friendsmeets";
<?php require_once("../php_includes/db_conx.php"); // This block deletes all accounts that do not activate after 3 days
$sql = "SELECT id, username FROM users WHERE signup<=CURRENT_DATE - INTERVAL 3 DAY AND activated='0'"; $query = mysqli_query($db_conx, $sql); $numrows = mysqli_num_rows($query); if($numrows > 0){ 	while($row = mysqli_fetch_array($query, MYSQLI_ASSOC)) { 	 $id = $row['id']; 	 $username = $row['username']; 	 $userFolder = "../user/$username"; 	 if(is_dir($userFolder)) { rmdir($userFolder); } 	 mysqli_query($db_conx, "DELETE FROM users WHERE id='$id' AND username='$username' AND activated='0' LIMIT 1"); 	 mysqli_query($db_conx, "DELETE FROM useroptions WHERE username='$username' LIMIT 1"); } } ?>



	 </body>
 </html>